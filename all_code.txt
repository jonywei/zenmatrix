
==============================
FILE: ./corezen_backend/urls.py
==============================
from django.contrib import admin
from django.urls import path, include
from django.conf import settings
from django.conf.urls.static import static
from rest_framework.routers import DefaultRouter
from core.views import *

router = DefaultRouter()
router.register(r'products', ProductViewSet)
router.register(r'contacts', ContactViewSet)
router.register(r'rentals', RentalViewSet)
router.register(r'analysis', AnalysisViewSet, basename='analysis')

urlpatterns = [
    path('admin/', admin.site.urls),
    path('api/', include(router.urls)),
    
    # æ ¸å¿ƒé¡µé¢
    path('', index_page),
    path('entry/', entry_page),
    path('sales/', sales_page),
    path('contact/', contact_page),
    path('inventory/', inventory_page),
    
    # ç§Ÿèµ
    path('rental/', rental_hub_page),
    path('rental/create/', rental_create_page),
    path('return/', rental_hub_page),
    
    # æŠ¥è¡¨
    path('analysis/profit/', profit_page),
    path('analysis/finance/', finance_page),
    path('analysis/account/', account_page),
    
    # ç™»å½•ä¸ç”¨æˆ· (Day 6 æ–°å¢)
    path('login/', login_page),
    path('profile/', profile_page),
    
    # Auth API
    path('api/login/', api_login),
    path('api/logout/', api_logout),
    path('api/change_password/', api_change_password),
]

if settings.DEBUG:
    urlpatterns += static(settings.MEDIA_URL, document_root=settings.MEDIA_ROOT)
==============================
FILE: ./corezen_backend/wsgi.py
==============================
"""
WSGI config for corezen_backend project.

It exposes the WSGI callable as a module-level variable named ``application``.

For more information on this file, see
https://docs.djangoproject.com/en/4.2/howto/deployment/wsgi/
"""

import os

from django.core.wsgi import get_wsgi_application

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'corezen_backend.settings')

application = get_wsgi_application()

==============================
FILE: ./corezen_backend/asgi.py
==============================
"""
ASGI config for corezen_backend project.

It exposes the ASGI callable as a module-level variable named ``application``.

For more information on this file, see
https://docs.djangoproject.com/en/4.2/howto/deployment/asgi/
"""

import os

from django.core.asgi import get_asgi_application

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'corezen_backend.settings')

application = get_asgi_application()

==============================
FILE: ./corezen_backend/settings.py
==============================
from pathlib import Path
import os

BASE_DIR = Path(__file__).resolve().parent.parent
SECRET_KEY = 'django-insecure-corezen-secret-key-change-me'
DEBUG = True
ALLOWED_HOSTS = ['*']

INSTALLED_APPS = [
    'simpleui',
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    # --- ç¬¬ä¸‰æ–¹åº“ ---
    'rest_framework',
    'corsheaders',
    # --- æˆ‘ä»¬çš„æ ¸å¿ƒåº”ç”¨ ---
    'core',
]

MIDDLEWARE = [
    'django.middleware.security.SecurityMiddleware',
    'django.contrib.sessions.middleware.SessionMiddleware',
    'corsheaders.middleware.CorsMiddleware', # è·¨åŸŸæ”¯æŒ
    'django.middleware.common.CommonMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
]

ROOT_URLCONF = 'corezen_backend.urls'

TEMPLATES = [
    {
        'BACKEND': 'django.template.backends.django.DjangoTemplates',
        'DIRS': [],
        'APP_DIRS': True,
        'OPTIONS': {
            'context_processors': [
                'django.template.context_processors.debug',
                'django.template.context_processors.request',
                'django.contrib.auth.context_processors.auth',
                'django.contrib.messages.context_processors.messages',
            ],
        },
    },
]

WSGI_APPLICATION = 'corezen_backend.wsgi.application'

# --- æ ¸å¿ƒï¼šè¿æ¥ PostgreSQL æ•°æ®åº“ ---
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.postgresql',
        'NAME': 'corezen',
        'USER': 'zen_admin',
        'PASSWORD': 'zen_secure_password',
        'HOST': 'db',  # Docker å†…éƒ¨åŸŸå
        'PORT': 5432,
    }
}

AUTH_PASSWORD_VALIDATORS = []
LANGUAGE_CODE = 'zh-hans' # ä¸­æ–‡ç•Œé¢
TIME_ZONE = 'Asia/Shanghai' # ä¸­å›½æ—¶é—´
USE_I18N = True
USE_TZ = True

STATIC_URL = 'static/'
DEFAULT_AUTO_FIELD = 'django.db.models.BigAutoField'

# --- è‡ªå®šä¹‰ç”¨æˆ·æ¨¡å‹ ---
AUTH_USER_MODEL = 'core.CustomUser'

# --- å›¾ç‰‡å­˜å‚¨è·¯å¾„ (æ˜ å°„åˆ°è…¾è®¯äº‘ç¡¬ç›˜) ---
MEDIA_URL = '/uploads/'
MEDIA_ROOT = os.path.join(BASE_DIR, 'uploads')
# --- SimpleUI ä¸ªæ€§åŒ–é…ç½® (åŠ åœ¨æ–‡ä»¶æœ€å) ---
SIMPLEUI_HOME_INFO = False  # å…³é—­é¦–é¡µå¹¿å‘Š
SIMPLEUI_ANALYSIS = False   # å…³é—­åˆ†æ
SIMPLEUI_LOGO = 'https://i.ibb.co/5xbz0qj/logo.png' # è¿™é‡Œä»¥åå¯ä»¥æ¢æˆä½ çš„ Corezen Logo
SIMPLEUI_DEFAULT_THEME = 'admin.lte.css' # é»˜è®¤æ·±è‰²ä¸»é¢˜
# SimpleUI ä¼˜åŒ–é…ç½®
SIMPLEUI_HOME_INFO = False 
SIMPLEUI_ANALYSIS = False
SIMPLEUI_DEFAULT_ICON = False
# å…³é”®ï¼šåœ¨å·¦ä¾§èœå•å¢åŠ ä¸€ä¸ªâ€œè¿”å›å·¥ä½œå°â€çš„æŒ‰é’®
SIMPLEUI_CONFIG = {
    'system_keep': True,
    'dynamic_menus': [{
        'name': 'ğŸ”™ è¿”å›å·¥ä½œå°',
        'url': '/',
        'icon': 'fa fa-home'
    }]
}
==============================
FILE: ./corezen_backend/__init__.py
==============================

==============================
FILE: ./core/apps.py
==============================

==============================
FILE: ./core/views.py
==============================
from rest_framework import viewsets, filters
from rest_framework.decorators import action
from rest_framework.response import Response
from django.utils import timezone
from django.shortcuts import render, redirect
from django.db import transaction
from django.db.models import Sum, Q
from decimal import Decimal
from django.contrib.auth import authenticate, login, logout
from django.http import JsonResponse
from django.views.decorators.csrf import csrf_exempt
import json
import datetime

# å¼•å…¥æ¨¡å‹
from .models import Product, Contact, RentalContract, Transaction, CapitalAccount, CustomUser
from .serializers import ProductSerializer, ContactSerializer, RentalContractSerializer, TransactionSerializer

# --- 1. é¡µé¢è·¯ç”± (ä¿æŒä¸å˜) ---
def index_page(request): 
    if not request.user.is_authenticated: return redirect('/login/')
    return render(request, 'index.html')
def entry_page(request): return render(request, 'entry.html') if request.user.is_authenticated else redirect('/login/')
def sales_page(request): return render(request, 'sales.html') if request.user.is_authenticated else redirect('/login/')
def contact_page(request): return render(request, 'contact.html') if request.user.is_authenticated else redirect('/login/')
def inventory_page(request): return render(request, 'inventory.html') if request.user.is_authenticated else redirect('/login/')
def rental_hub_page(request): return render(request, 'rental_hub.html') if request.user.is_authenticated else redirect('/login/')
def rental_create_page(request): return render(request, 'rental_create.html') if request.user.is_authenticated else redirect('/login/')
def profit_page(request): return render(request, 'analysis_profit.html') if request.user.is_authenticated else redirect('/login/')
def finance_page(request): return render(request, 'analysis_finance.html') if request.user.is_authenticated else redirect('/login/')
def account_page(request): return render(request, 'analysis_account.html') if request.user.is_authenticated else redirect('/login/')
def profile_page(request): return render(request, 'profile.html') if request.user.is_authenticated else redirect('/login/')
def login_page(request): return redirect('/') if request.user.is_authenticated else render(request, 'login.html')

# --- 2. è®¤è¯ API (ä¿æŒä¸å˜) ---
@csrf_exempt
def api_login(request):
    if request.method == 'POST':
        try: data = json.loads(request.body)
        except: data = request.POST
        user = authenticate(username=data.get('username'), password=data.get('password'))
        if user:
            login(request, user)
            return JsonResponse({'status': 'ok'})
        return JsonResponse({'status': 'error', 'msg': 'è´¦å·æˆ–å¯†ç é”™è¯¯'})
    return JsonResponse({'status': 'error', 'msg': 'Method not allowed'})

def api_logout(request):
    logout(request)
    return JsonResponse({'status': 'ok'})

@csrf_exempt
def api_change_password(request):
    if not request.user.is_authenticated: return JsonResponse({'status': 'error'}, status=403)
    try:
        data = json.loads(request.body)
        request.user.set_password(data.get('password'))
        request.user.save()
        logout(request)
        return JsonResponse({'status': 'ok'})
    except: return JsonResponse({'status': 'error'})

# --- 3. ä¸šåŠ¡ API ---

class ProductViewSet(viewsets.ModelViewSet):
    queryset = Product.objects.all().order_by('-created_at')
    serializer_class = ProductSerializer
    filter_backends = [filters.SearchFilter]
    search_fields = ['name', 'zencode', 'note']

    def get_queryset(self):
        status = self.request.query_params.get('status')
        if status: return self.queryset.filter(status=status)
        return self.queryset

    def perform_create(self, serializer):
        user = self.request.user
        initials = getattr(user, 'initials', 'AD')
        category = self.request.data.get('category', 'ZX')
        year = str(timezone.now().year)[-2:]
        month_map = {10:'A',11:'B',12:'C'}
        month = month_map.get(timezone.now().month, str(timezone.now().month))
        day = f"{timezone.now().day:02d}"
        start = timezone.now().replace(hour=0, minute=0, second=0)
        count = Product.objects.filter(created_at__gte=start, category=category).count() + 1
        zencode = f"{year}{month}{day}{initials}{category}{count}"
        product = serializer.save(zencode=zencode)

        supplier_id = self.request.data.get('supplier_id')
        paid_amount = Decimal(str(self.request.data.get('paid_amount', 0) or 0))
        account_id = self.request.data.get('account_id')
        
        if supplier_id and str(supplier_id) != '0':
            try:
                supplier = Contact.objects.get(id=supplier_id)
                if paid_amount > 0 and account_id:
                    acc = CapitalAccount.objects.get(id=account_id)
                    Transaction.objects.create(contact=supplier, product=product, account=acc, amount=paid_amount, type='BUY', operator=user, remark=f"é‡‡è´­: {product.name}")
                    acc.current_balance -= paid_amount
                    acc.save()
                
                # è®¡ç®—æ¬ æ¬¾ï¼šæˆæœ¬ - å·²ä»˜ = æ¬ ä¾›åº”å•†çš„é’±
                # å¦‚æœæ¬ æ¬¾ï¼Œä¾›åº”å•†ä½™é¢å‡å°‘ï¼ˆè´Ÿæ•°è¡¨ç¤ºæˆ‘æ¬ ä»–ï¼‰
                debt = product.cost_price - paid_amount
                if debt != 0:
                    supplier.balance -= debt
                    supplier.save()
            except Exception: pass

    @action(detail=True, methods=['post'])
    def sell(self, request, pk=None):
        product = self.get_object()
        price = Decimal(str(request.data.get('price')))
        received_amount = Decimal(str(request.data.get('received_amount', 0) or 0))
        contact_id = request.data.get('contact_id')
        account_id = request.data.get('account_id')
        if product.status != 'IN_STOCK': return Response({'detail': 'éåœ¨åº“å•†å“'}, status=400)
        try:
            with transaction.atomic():
                product.status = 'SOLD'
                product.sold_price = price
                product.save()
                contact = Contact.objects.get(id=contact_id)
                
                if received_amount > 0 and account_id:
                    acc = CapitalAccount.objects.get(id=account_id)
                    Transaction.objects.create(contact=contact, product=product, account=acc, amount=received_amount, type='SALE', operator=request.user, remark=f"é”€å”®: {product.name}")
                    acc.current_balance += received_amount
                    acc.save()
                else:
                    # å³ä½¿æ˜¯å…¨é¢æŒ‚è´¦ï¼Œä¹Ÿè¦è®°å½•ä¸€æ¡ SALE è®°å½•ï¼Œç”¨äºè®°å½•â€œæ˜¯è°å–çš„â€ä»¥åŠç»Ÿè®¡ä»Šæ—¥é”€é‡
                    Transaction.objects.create(contact=contact, product=product, amount=0, type='SALE', operator=request.user, remark=f"é”€å”®(æŒ‚è´¦): {product.name}")

                # è®¡ç®—æ¬ æ¬¾ï¼šå”®ä»· - å·²æ”¶ = å®¢æˆ·æ¬ æˆ‘çš„é’±
                # å¦‚æœæ¬ æ¬¾ï¼Œå®¢æˆ·ä½™é¢å¢åŠ ï¼ˆæ­£æ•°è¡¨ç¤ºä»–æ¬ æˆ‘ï¼‰
                debt = price - received_amount
                if debt != 0:
                    contact.balance += debt
                    contact.save()
                return Response({'msg': 'å‡ºåº“æˆåŠŸ'})
        except Exception as e: return Response({'detail': str(e)}, status=500)

class ContactViewSet(viewsets.ModelViewSet):
    queryset = Contact.objects.all()
    serializer_class = ContactSerializer
    filter_backends = [filters.SearchFilter]
    search_fields = ['name', 'phone']

    @action(detail=True, methods=['get'])
    def history(self, request, pk=None):
        contact = self.get_object()
        txs = Transaction.objects.filter(contact=contact).order_by('-created_at')
        data = [{'id':t.id, 'date':t.created_at.strftime('%Y-%m-%d'), 'type':t.get_type_display(), 'amount':t.amount, 'product':t.product.name if t.product else '-', 'remark':t.remark, 'operator':t.operator.initials if t.operator else ''} for t in txs]
        return Response(data)

    @action(detail=True, methods=['post'])
    def repay(self, request, pk=None):
        contact = self.get_object()
        amount = Decimal(str(request.data.get('amount') or 0))
        acc_id = request.data.get('account_id')
        action = request.data.get('action_type')
        
        if amount <= 0 or not acc_id: return Response({'error': 'å‚æ•°é”™è¯¯'}, 400)
        
        try:
            with transaction.atomic():
                acc = CapitalAccount.objects.get(id=acc_id)
                if action == 'in':
                    # æ”¶æ¬¾æ ¸é”€ (å®¢æˆ·è¿˜é’±)ï¼šä½™é¢ä»æ­£æ•°å˜å°
                    Transaction.objects.create(contact=contact, account=acc, amount=amount, type='OTHER', operator=request.user, remark='æ”¶æ¬¾æ ¸é”€')
                    acc.current_balance += amount
                    contact.balance -= amount
                else:
                    # ä»˜æ¬¾æ ¸é”€ (æˆ‘è¿˜ä¾›åº”å•†)ï¼šä½™é¢ä»è´Ÿæ•°å˜å¤§ï¼ˆè¶‹å‘0ï¼‰
                    Transaction.objects.create(contact=contact, account=acc, amount=amount, type='BUY', operator=request.user, remark='ä»˜æ¬¾æ ¸é”€')
                    acc.current_balance -= amount
                    contact.balance += amount
                
                acc.save()
                contact.save()
                return Response({'msg': 'ok'})
        except Exception as e: return Response({'error': str(e)}, 500)

class RentalViewSet(viewsets.ModelViewSet):
    queryset = RentalContract.objects.all().order_by('-id')
    serializer_class = RentalContractSerializer
    
    @action(detail=False, methods=['post'])
    def create_lease(self, request):
        data = request.data
        try:
            with transaction.atomic():
                product = Product.objects.get(id=data['product_id'])
                contact = Contact.objects.get(id=data['contact_id'])
                deposit = Decimal(str(data.get('deposit', 0)))
                # å…¼å®¹å¤„ç†
                start_date = data.get('start_date', timezone.now())
                duration = data.get('duration', '1')
                
                RentalContract.objects.create(
                    contact=contact, product=product, 
                    start_date=start_date, duration=duration,
                    rent_strategy=data.get('rent_strategy', 'MONTHLY'), 
                    rent_price=Decimal(str(data.get('rent_price', 0))), 
                    deposit_amount=deposit, 
                    depreciation_monthly=Decimal(str(data.get('depreciation_monthly', 0))), 
                    initial_value=product.cost_price or 0
                )
                product.status = 'RENTED'
                product.save()
                
                # âš ï¸ æ ¸å¿ƒä¿®å¤ï¼šæ— è®ºæŠ¼é‡‘æ˜¯å¦ä¸º0ï¼Œéƒ½å¿…é¡»åˆ›å»ºä¸€æ¡Transaction
                # 1. ç¡®ä¿é¦–é¡µâ€œä»Šæ—¥é”€å”®â€èƒ½ç»Ÿè®¡åˆ°è¿™ç¬”ä¸šåŠ¡
                # 2. ç¡®ä¿è®°å½•äº† operatorï¼ˆæ“ä½œäººï¼‰ï¼Œæ–¹ä¾¿åç»­è¿½è¸ª
                acc = CapitalAccount.objects.first()
                remark_txt = f"ç§Ÿèµå¼€å•: {product.zencode}"
                if deposit > 0:
                    remark_txt += f" (æŠ¼é‡‘Â¥{deposit})"
                
                Transaction.objects.create(
                    contact=contact, 
                    product=product, 
                    account=acc, # å¦‚æœæ²¡è´¦æˆ·å¯ä¸ºç©ºï¼Œä½†ä¸ºäº†é€»è¾‘ç»Ÿä¸€å»ºè®®å…³è”
                    amount=deposit, 
                    type='RENT', 
                    operator=request.user, 
                    remark=remark_txt
                )
                
                if deposit > 0 and acc:
                    acc.current_balance += deposit
                    acc.save()
                    
                return Response({'msg': 'ç§Ÿèµå¼€å•æˆåŠŸ'})
        except Exception as e: return Response({'error': str(e)}, 500)

    @action(detail=True, methods=['post'])
    def settle(self, request, pk=None):
        contract = self.get_object()
        end_value = request.data.get('end_value')
        if not end_value: return Response({'error': 'å¿…é¡»å¡«å†™å›åº“è¯„ä¼°ä»·'}, status=400)
        try:
            with transaction.atomic():
                product = contract.product
                product.cost_price = Decimal(str(end_value))
                product.status = 'IN_STOCK'
                product.save()
                contract.is_active = False
                contract.save()
                
                Transaction.objects.create(contact=contract.contact, product=product, amount=0, type='OTHER', operator=request.user, remark=f"ç§Ÿèµå½’è¿˜: {product.zencode}")
                
                return Response({'msg': 'ç»“ç®—æˆåŠŸ'})
        except Exception as e: return Response({'error': str(e)}, 500)

class AnalysisViewSet(viewsets.ViewSet):
    
    @action(detail=False)
    def dashboard(self, request):
        # âš ï¸ æ ¸å¿ƒä¿®å¤ï¼šä½¿ç”¨æœ¬åœ°æ—¶é—´ï¼Œè§£å†³æ—¶åŒºå¯¼è‡´çš„â€œä»Šæ—¥æ•°æ®â€ç»Ÿè®¡ä¸å‡†é—®é¢˜
        today = timezone.localtime(timezone.now()).date()
        
        stock_val = Product.objects.filter(status='IN_STOCK').aggregate(Sum('cost_price'))['cost_price__sum'] or 0
        stock_count = Product.objects.filter(status='IN_STOCK').count()
        today_entry = Product.objects.filter(created_at__date=today).count()
        
        # âš ï¸ ä¿®æ­£ï¼šä»Šæ—¥é”€å”® = é”€å”®å• + ç§Ÿèµå• (åªè¦æ˜¯ä»Šå¤©äº§ç”Ÿçš„æµæ°´)
        today_sale = Transaction.objects.filter(
            Q(type='SALE') | Q(type='RENT'), 
            created_at__date=today
        ).count()
        
        recent_txs = Transaction.objects.all().select_related('product').order_by('-created_at')[:5]
        recent_list = []
        for t in recent_txs:
            # åªè¦ä¸æ˜¯é‡‡è´­(æ”¯å‡º)ï¼Œéƒ½ç®—å¹¿ä¹‰çš„â€œæ”¶å…¥â€ç±»æ“ä½œï¼ˆåŒ…æ‹¬0å…ƒæ“ä½œï¼‰
            is_income = t.type in ['SALE', 'RENT', 'OTHER']
            product_name = t.product.name if t.product else (t.remark or '-')
            desc = f"{t.get_type_display()} - {product_name}"
            recent_list.append({
                'id': t.id, 'desc': desc, 'change_message': desc, 'action_flag': t.type,
                'action_type': t.get_type_display(),
                'amount': t.amount, 'is_income': is_income, 'time': timezone.localtime(t.created_at).strftime('%m-%d %H:%M')
            })
        return Response({
            'stock_value': stock_val, 'stock_count': stock_count,
            'today_entry': today_entry, 'today_sale': today_sale, 'recent_list': recent_list
        })

    @action(detail=False)
    def profit_dashboard(self, request):
        start_date = request.query_params.get('start_date')
        end_date = request.query_params.get('end_date')
        staff_id = request.query_params.get('staff_id')

        query = Product.objects.filter(status='SOLD').order_by('-created_at')
        if start_date and end_date:
            query = query.filter(created_at__date__gte=start_date, created_at__date__lte=end_date)
        
        # âš ï¸ ç­›é€‰é€»è¾‘ï¼šæŸ¥æ‰¾ Transaction çš„æ“ä½œäºº
        if staff_id:
            p_ids = Transaction.objects.filter(operator_id=staff_id, type='SALE').values_list('product_id', flat=True)
            query = query.filter(id__in=p_ids)

        details = []
        sales_sum = 0
        cost_sum = 0
        for p in query:
            s = p.sold_price or 0
            c = p.cost_price or 0
            profit = s - c
            sales_sum += s
            cost_sum += c
            
            # å…³è”æŸ¥è¯¢é”€å”®å‘˜
            sale_tx = Transaction.objects.filter(product=p, type='SALE').last()
            staff_name = '-'
            customer_name = '-'
            if sale_tx:
                if sale_tx.operator:
                    # ä¼˜å…ˆæ˜¾ç¤ºçœŸå®å§“åï¼Œæ²¡æœ‰åˆ™æ˜¾ç¤ºç”¨æˆ·å
                    staff_name = f"{sale_tx.operator.last_name}{sale_tx.operator.first_name}".strip() or sale_tx.operator.username
                if sale_tx.contact:
                    customer_name = sale_tx.contact.name

            details.append({
                'id': p.id, 'date': p.created_at.strftime('%Y-%m-%d'), 'zencode': p.zencode, 
                'product_name': p.name, 'customer': customer_name, 'staff': staff_name, 
                'sales': s, 'cost': c, 'profit': profit
            })
        
        # è¿”å›æ‰€æœ‰é”€å”®å‘˜
        raw_users = CustomUser.objects.values('id', 'username', 'last_name', 'first_name')
        staff_list = []
        for u in raw_users:
            real_name = f"{u['last_name']}{u['first_name']}".strip()
            staff_list.append({'id': u['id'], 'name': real_name if real_name else u['username']})
        
        return Response({
            'summary': {'sales': sales_sum, 'cost': cost_sum, 'profit': sales_sum - cost_sum, 'count': len(details)}, 
            'list': details, 'options': {'staff': staff_list}
        })

    @action(detail=False)
    def accounting(self, request):
        accounts = CapitalAccount.objects.all()
        total_cash = sum([a.current_balance for a in accounts]) or 0
        stock_value = Product.objects.filter(status='IN_STOCK').aggregate(Sum('cost_price'))['cost_price__sum'] or 0
        
        # âš ï¸ ä¿®æ­£è´¢åŠ¡é€»è¾‘ï¼š
        # å¤§äº0 = å®¢æˆ·æ¬ æˆ‘ (Receivable åº”æ”¶)
        # å°äº0 = æˆ‘æ¬ ä¾›åº”å•† (Payable åº”ä»˜)
        receivable = Contact.objects.filter(balance__gt=0).aggregate(Sum('balance'))['balance__sum'] or 0
        payable = Contact.objects.filter(balance__lt=0).aggregate(Sum('balance'))['balance__sum'] or 0
        
        # å‡€èµ„äº§ = ç°é‡‘ + åº“å­˜ + åº”æ”¶ + åº”ä»˜(è´Ÿæ•°)
        net_worth = total_cash + stock_value + receivable + payable 
        
        return Response({
            'cash': total_cash, 'stock': stock_value, 'receivable': receivable, 'payable': payable, 'net_worth': net_worth,
            'accounts': [{'id': a.id, 'name': a.name, 'balance': a.current_balance} for a in accounts]
        })
    
    @action(detail=False)
    def account_history(self, request):
        acc_id = request.query_params.get('id')
        txs = Transaction.objects.filter(account_id=acc_id).order_by('-created_at')
        data = []
        for t in txs:
            sign = '+' if t.type in ['SALE', 'RENT', 'OTHER'] else '-'
            color = 'text-red-500' if sign == '+' else 'text-green-500'
            target = t.contact.name if t.contact else (t.product.name if t.product else '-')
            data.append({'id':t.id, 'date':t.created_at.strftime('%Y-%m-%d'), 'type':t.get_type_display(), 'amount':t.amount, 'sign':sign, 'color':color, 'target':target, 'remark':t.remark})
        return Response(data)
==============================
FILE: ./core/serializers.py
==============================
from rest_framework import serializers
from .models import Product, Contact, RentalContract, Transaction, CapitalAccount

class ProductSerializer(serializers.ModelSerializer):
    class Meta:
        model = Product
        fields = '__all__'

class ContactSerializer(serializers.ModelSerializer):
    class Meta:
        model = Contact
        fields = '__all__'

class RentalContractSerializer(serializers.ModelSerializer):
    # å¢åŠ å…³è”å­—æ®µæ˜¾ç¤ºï¼Œæ–¹ä¾¿å‰ç«¯å–åå­—
    contact_name = serializers.CharField(source='contact.name', read_only=True)
    product_name = serializers.CharField(source='product.name', read_only=True)
    product_zencode = serializers.CharField(source='product.zencode', read_only=True)
    
    class Meta:
        model = RentalContract
        fields = '__all__'

class TransactionSerializer(serializers.ModelSerializer):
    class Meta:
        model = Transaction
        fields = '__all__'

class CapitalAccountSerializer(serializers.ModelSerializer):
    class Meta:
        model = CapitalAccount
        fields = '__all__'
==============================
FILE: ./core/admin.py
==============================
from django.contrib import admin
from django.contrib.auth.admin import UserAdmin
from .models import CustomUser, CapitalAccount, Contact, Product, RentalContract, Transaction

# 1. å‘˜å·¥/ç”¨æˆ·ç®¡ç†
@admin.register(CustomUser)
class CustomUserAdmin(UserAdmin):
    list_display = ('username', 'role', 'initials', 'is_staff', 'is_active')
    fieldsets = UserAdmin.fieldsets + (
        ('å‘˜å·¥ä¿¡æ¯', {'fields': ('role', 'initials')}),
    )

# 2. èµ„é‡‘è´¦æˆ·ç®¡ç†
@admin.register(CapitalAccount)
class CapitalAccountAdmin(admin.ModelAdmin):
    list_display = ('name', 'current_balance', 'initial_balance')

# 3. å®¢æˆ·/ä¾›åº”å•†æ¡£æ¡ˆ
@admin.register(Contact)
class ContactAdmin(admin.ModelAdmin):
    list_display = ('name', 'phone', 'balance', 'address')
    search_fields = ('name', 'phone')

# 4. å•†å“åº“å­˜ç®¡ç†
@admin.register(Product)
class ProductAdmin(admin.ModelAdmin):
    list_display = ('zencode', 'name', 'category', 'status', 'cost_price', 'retail_price', 'created_at')
    list_filter = ('status', 'category')
    search_fields = ('name', 'zencode', 'note')

# 5. ç§ŸèµåˆåŒç®¡ç† (æ ¸å¿ƒä¿®å¤ç‚¹)
@admin.register(RentalContract)
class RentalContractAdmin(admin.ModelAdmin):
    # ä¿®å¤ï¼šè¿™é‡ŒåŸæ¥å†™çš„æ˜¯ rent_amountï¼Œç°åœ¨æ”¹æˆäº† rent_price
    list_display = ('contact', 'product', 'start_date', 'rent_price', 'deposit_amount', 'is_active')
    list_filter = ('is_active', 'rent_strategy')
    search_fields = ('contact__name', 'product__zencode')

# 6. èµ„é‡‘/äº¤æ˜“æµæ°´
@admin.register(Transaction)
class TransactionAdmin(admin.ModelAdmin):
    list_display = ('type', 'amount', 'contact', 'account', 'created_at', 'operator')
    list_filter = ('type', 'account', 'created_at')
    search_fields = ('contact__name', 'remark')
# ... (ä¿ç•™ä¸Šé¢çš„ä»£ç )

# éšè—ç³»ç»Ÿè‡ªå¸¦çš„ "ç»„" (Groups)ï¼Œè®©åå°æ›´å¹²å‡€
from django.contrib.auth.models import Group
admin.site.unregister(Group)

# ä¿®æ”¹åå°é¡¶éƒ¨çš„æ ‡é¢˜ï¼Œçœ‹ç€æ›´æ­£è§„
admin.site.site_header = 'ZenMatrix ç»è¥ç®¡ç†åå°'
admin.site.site_title = 'ZenMatrix'
admin.site.index_title = 'ä¼ä¸šæ•°æ®ä¸­å¿ƒ'
==============================
FILE: ./core/models.py
==============================
from django.db import models
from django.contrib.auth.models import AbstractUser
from django.utils import timezone

# 1. ç”¨æˆ·
class CustomUser(AbstractUser):
    ROLE_CHOICES = (('ADMIN', 'ç®¡ç†å‘˜'), ('FINANCE', 'è´¢åŠ¡'), ('SALES', 'é”€å”®'))
    role = models.CharField(max_length=10, choices=ROLE_CHOICES, default='SALES', verbose_name="è§’è‰²")
    initials = models.CharField(max_length=5, default='XX', verbose_name="å§“åé¦–å­—æ¯", help_text="ç”¨äºç”Ÿæˆå•å·ï¼Œå¦‚ WZ")
    
    class Meta:
        verbose_name = "å‘˜å·¥è´¦å·"
        verbose_name_plural = verbose_name

# 2. èµ„é‡‘è´¦æˆ·
class CapitalAccount(models.Model):
    name = models.CharField(max_length=50, verbose_name="è´¦æˆ·åç§°", help_text="å¦‚: æ”¯ä»˜å®, å¾®ä¿¡")
    initial_balance = models.DecimalField(max_digits=12, decimal_places=2, default=0, verbose_name="æœŸåˆä½™é¢")
    current_balance = models.DecimalField(max_digits=12, decimal_places=2, default=0, verbose_name="å½“å‰ä½™é¢")
    
    def __str__(self): return f"{self.name} (Â¥{self.current_balance})"
    class Meta:
        verbose_name = "èµ„é‡‘è´¦æˆ·"
        verbose_name_plural = verbose_name

# 3. å®¢æˆ·/ä¾›åº”å•†
class Contact(models.Model):
    name = models.CharField(max_length=50, unique=True, verbose_name="å§“å/æ˜µç§°")
    phone = models.CharField(max_length=20, blank=True, verbose_name="ç”µè¯")
    address = models.CharField(max_length=100, blank=True, verbose_name="åœ°å€/æ¡£å£")
    balance = models.DecimalField(max_digits=10, decimal_places=2, default=0, verbose_name="åº”æ”¶/åº”ä»˜ä½™é¢")
    
    def __str__(self): return self.name
    class Meta:
        verbose_name = "å®¢æˆ·/ä¾›åº”å•†æ¡£æ¡ˆ"
        verbose_name_plural = verbose_name

# 4. å•†å“
class Product(models.Model):
    TYPE_CHOICES = (('ZJ', 'æ•´æœº'), ('SJ', 'æ•£ä»¶'), ('XS', 'æ˜¾ç¤ºå™¨'), ('ZX', 'æ‚é¡¹'))
    STATUS_CHOICES = (('IN_STOCK', 'åœ¨åº“'), ('RENTED', 'åœ¨ç§Ÿ'), ('SOLD', 'å·²å”®'), ('REPAIR', 'ç»´ä¿®'))
    
    zencode = models.CharField(max_length=20, unique=True, blank=True, verbose_name="ZenCodeç¼–ç ")
    name = models.CharField(max_length=200, blank=True, verbose_name="å•†å“åç§°")
    category = models.CharField(max_length=2, choices=TYPE_CHOICES, verbose_name="åˆ†ç±»")
    # è§„æ ¼
    cpu = models.CharField(max_length=50, blank=True, verbose_name="CPU")
    gpu = models.CharField(max_length=50, blank=True, verbose_name="æ˜¾å¡")
    ram = models.CharField(max_length=50, blank=True, verbose_name="å†…å­˜")
    disk = models.CharField(max_length=50, blank=True, verbose_name="ç¡¬ç›˜")
    note = models.CharField(max_length=100, blank=True, verbose_name="å¤‡æ³¨")
    # ä»·æ ¼
    cost_price = models.DecimalField(max_digits=10, decimal_places=2, default=0, verbose_name="å…¥åº“æˆæœ¬")
    peer_price = models.DecimalField(max_digits=10, decimal_places=2, default=0, verbose_name="åŒè¡Œåº•ä»·")
    retail_price = models.DecimalField(max_digits=10, decimal_places=2, default=0, verbose_name="é›¶å”®æŒ‡å¯¼")
    sold_price = models.DecimalField(max_digits=10, decimal_places=2, null=True, blank=True, verbose_name="å®é™…æˆäº¤ä»·")
    # çŠ¶æ€
    status = models.CharField(max_length=10, choices=STATUS_CHOICES, default='IN_STOCK', verbose_name="å½“å‰çŠ¶æ€")
    image = models.ImageField(upload_to='%Y/%m/', blank=True, null=True, verbose_name="å›¾ç‰‡")
    created_at = models.DateTimeField(auto_now_add=True, verbose_name="å…¥åº“æ—¶é—´")

    class Meta:
        verbose_name = "åº“å­˜å•†å“"
        verbose_name_plural = verbose_name

    def save(self, *args, **kwargs):
        if self.category == 'ZJ' and not self.name:
            gpu_str = self.gpu if self.gpu else "æ ¸æ˜¾"
            parts = [self.cpu, gpu_str, self.ram, self.disk, self.note]
            self.name = " ".join([p for p in parts if p])
        super().save(*args, **kwargs)

# 5. ç§Ÿèµåˆçº¦
class RentalContract(models.Model):
    STRATEGY_CHOICES = (('DAILY', 'æ—¥ç§Ÿ'), ('MONTHLY', 'æœˆç§Ÿ'))
    contact = models.ForeignKey(Contact, on_delete=models.CASCADE, verbose_name="å®¢æˆ·")
    product = models.ForeignKey(Product, on_delete=models.CASCADE, verbose_name="è®¾å¤‡")
    start_date = models.DateField(default=timezone.now, verbose_name="èµ·ç§Ÿæ—¥")
    end_date = models.DateField(null=True, blank=True, verbose_name="å½’è¿˜æ—¥")
    deposit_amount = models.DecimalField(max_digits=10, decimal_places=2, default=0, verbose_name="å®æ”¶æŠ¼é‡‘")
    rent_strategy = models.CharField(max_length=10, choices=STRATEGY_CHOICES, default='MONTHLY', verbose_name="è®¡è´¹æ–¹å¼")
    rent_price = models.DecimalField(max_digits=10, decimal_places=2, verbose_name="ç§Ÿé‡‘å•ä»·")
    initial_value = models.DecimalField(max_digits=10, decimal_places=2, verbose_name="å‡ºåº“ä»·å€¼")
    depreciation_monthly = models.DecimalField(max_digits=10, decimal_places=2, default=0, verbose_name="æœˆæŠ˜æ—§ä¼°ç®—")
    is_active = models.BooleanField(default=True, verbose_name="ç§Ÿèµä¸­")
    
    class Meta:
        verbose_name = "ç§ŸèµåˆåŒ"
        verbose_name_plural = verbose_name

# 6. èµ„é‡‘æµæ°´
class Transaction(models.Model):
    TYPE_CHOICES = (('SALE', 'é”€å”®æ”¶å…¥'), ('RENT', 'ç§Ÿé‡‘/æŠ¼é‡‘'), ('BUY', 'é‡‡è´­æ”¯å‡º'), ('OTHER', 'å…¶ä»–'))
    contact = models.ForeignKey(Contact, on_delete=models.CASCADE, null=True, verbose_name="å…³è”æ–¹")
    product = models.ForeignKey(Product, on_delete=models.SET_NULL, null=True, blank=True, verbose_name="å…³è”å•†å“")
    account = models.ForeignKey(CapitalAccount, on_delete=models.SET_NULL, null=True, blank=True, verbose_name="èµ„é‡‘è´¦æˆ·")
    amount = models.DecimalField(max_digits=10, decimal_places=2, verbose_name="é‡‘é¢")
    type = models.CharField(max_length=10, choices=TYPE_CHOICES, verbose_name="ç±»å‹")
    operator = models.ForeignKey(CustomUser, on_delete=models.SET_NULL, null=True, verbose_name="ç»æ‰‹äºº")
    remark = models.CharField(max_length=200, blank=True, verbose_name="æ‘˜è¦")
    created_at = models.DateTimeField(auto_now_add=True, verbose_name="æ—¶é—´")
    
    class Meta:
        verbose_name = "è´¢åŠ¡æµæ°´"
        verbose_name_plural = verbose_name
==============================
FILE: ./core/__init__.py
==============================

{% extends 'base.html' %}
{% block title %}租赁管理{% endblock %}
{% block content %}
<div class="flex justify-between items-center mb-6">
    <h1 class="text-2xl font-bold text-gray-800">租赁管理</h1>
    <a href="/rental/create/" class="bg-blue-600 text-white px-6 py-2 rounded-lg shadow-md hover:bg-blue-700 font-bold">+ 新建合同</a>
</div>

<div id="listContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
    <div class="col-span-full text-center py-10 text-gray-400">加载中...</div>
</div>

<script>
    async function loadData() {
        try {
            // ⚠️ 重点：只拉 active 的，解决删不掉问题
            const res = await axios.get('/api/rentals/?is_active=true&t=' + Date.now());
            const list = res.data.results || res.data;
            render(list);
        } catch (err) {
            document.getElementById('listContainer').innerHTML = '<div class="col-span-full text-center text-red-500">加载失败</div>';
        }
    }

    function render(list) {
        const container = document.getElementById('listContainer');
        if (list.length === 0) {
            container.innerHTML = '<div class="col-span-full bg-white p-10 rounded-xl text-center text-gray-400 shadow-sm">暂无进行中的租赁订单</div>';
            return;
        }

        container.innerHTML = list.map(item => {
            const start = new Date(item.start_date);
            const duration = parseInt(item.duration || 1);
            const end = new Date(start);
            end.setMonth(start.getMonth() + duration);
            const diffDays = Math.ceil((end - new Date()) / (1000 * 60 * 60 * 24));
            
            let statusBadge = '';
            if (diffDays < 0) {
                statusBadge = `<span class="bg-red-100 text-red-700 px-2 py-1 rounded text-xs font-bold">已逾期 ${Math.abs(diffDays)} 天</span>`;
            } else if (diffDays <= 7) {
                statusBadge = `<span class="bg-orange-100 text-orange-700 px-2 py-1 rounded text-xs font-bold">剩 ${diffDays} 天</span>`;
            } else {
                statusBadge = `<span class="bg-blue-100 text-blue-700 px-2 py-1 rounded text-xs font-bold">剩 ${diffDays} 天</span>`;
            }

            return `
            <div class="bg-white rounded-xl shadow-sm hover:shadow-md transition border border-gray-100 overflow-hidden flex flex-col">
                <div class="p-5 flex-1">
                    <div class="flex justify-between items-start mb-3">
                        <h3 class="font-bold text-lg text-gray-800">${item.contact_name}</h3>
                        ${statusBadge}
                    </div>
                    <div class="text-sm text-gray-600 space-y-2">
                        <p class="flex items-center"><span class="w-16 text-gray-400">设备</span> <span class="font-medium truncate">${item.product_name}</span></p>
                        <p class="flex items-center"><span class="w-16 text-gray-400">编码</span> <span class="font-mono bg-gray-100 px-1 rounded text-xs">${item.product_code || '-'}</span></p>
                        <p class="flex items-center"><span class="w-16 text-gray-400">起租</span> <span>${item.start_date} (${item.duration}个月)</span></p>
                    </div>
                </div>
                <div class="bg-gray-50 px-5 py-3 border-t border-gray-100 flex justify-between items-center">
                    <div class="text-xs text-gray-500">押金: <span class="font-bold text-gray-700">¥${parseFloat(item.deposit_amount).toLocaleString()}</span></div>
                    <button onclick="settle(${item.id})" class="bg-white border border-red-200 text-red-500 hover:bg-red-50 text-sm px-3 py-1 rounded transition">结算归还</button>
                </div>
            </div>`;
        }).join('');
    }

    async function settle(id) {
        const val = prompt("请输入回库评估价值 (折旧后):");
        if (!val) return;
        try {
            await axios.post(`/api/rentals/${id}/settle/`, { end_value: val });
            alert("归还成功"); loadData();
        } catch (e) { alert("操作失败"); }
    }
    loadData();
</script>
{% endblock %}
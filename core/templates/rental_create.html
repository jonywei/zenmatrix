{% extends 'base.html' %}
{% block title %}新建租赁{% endblock %}
{% block content %}
<div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
    <div class="p-6 border-b border-gray-100 bg-gray-50"><h2 class="text-lg font-bold text-gray-800">新建租赁合同</h2></div>
    <form class="p-6 space-y-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <label class="block text-sm font-bold text-gray-700 mb-2">承租客户</label>
                <div class="flex gap-2">
                    <select id="contact_id" class="w-full h-12 border-gray-300 rounded-lg px-3 bg-white"><option>加载中...</option></select>
                    <button type="button" onclick="showAddModal()" class="w-12 h-12 bg-blue-100 text-blue-600 rounded-lg font-bold">+</button>
                </div>
            </div>
            <div>
                <label class="block text-sm font-bold text-gray-700 mb-2">租赁设备</label>
                <select id="product_id" class="w-full h-12 border-gray-300 rounded-lg px-3 bg-white"><option>加载中...</option></select>
            </div>
        </div>
        
        <div class="bg-orange-50 p-5 rounded-xl border border-orange-100 grid grid-cols-1 md:grid-cols-2 gap-6">
            <div><label class="block text-xs font-medium text-gray-600 mb-1">起租日期</label><input type="date" id="start_date" class="w-full h-10 border rounded px-3 bg-white"></div>
            <div><label class="block text-xs font-medium text-gray-600 mb-1">租期 (月)</label><input type="number" id="duration" value="12" class="w-full h-10 border rounded px-3 font-bold"></div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div><label class="block text-sm font-medium text-gray-700 mb-1">押金 (¥)</label><input type="number" id="deposit" placeholder="0" class="w-full h-10 border rounded px-3"></div>
            <div><label class="block text-sm font-medium text-gray-700 mb-1">租金 (¥/月)</label><input type="number" id="rent_price" class="w-full h-10 border rounded px-3 font-bold text-blue-600"></div>
            <div><label class="block text-sm font-medium text-gray-700 mb-1">月折旧 (¥)</label><input type="number" id="depreciation" placeholder="0" class="w-full h-10 border rounded px-3 text-red-500"></div>
        </div>
        <button type="button" onclick="submitForm()" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700 shadow-lg mt-4">确认创建</button>
    </form>
</div>

<div id="addModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
    <div class="bg-white p-6 rounded-lg w-80 shadow-xl">
        <h3 class="font-bold mb-4">新增客户</h3>
        <input id="newCName" class="w-full border rounded h-10 px-3 mb-3" placeholder="姓名">
        <input id="newCPhone" class="w-full border rounded h-10 px-3 mb-3" placeholder="电话">
        <input id="newCAddr" class="w-full border rounded h-10 px-3 mb-4" placeholder="地址/备注">
        <div class="flex justify-end gap-2">
            <button onclick="document.getElementById('addModal').classList.add('hidden')" class="px-4 py-2 bg-gray-100 rounded">取消</button>
            <button onclick="addC()" class="px-4 py-2 bg-blue-600 text-white rounded">保存</button>
        </div>
    </div>
</div>

<script>
    document.getElementById('start_date').value = new Date().toISOString().split('T')[0];
    
    async function init() {
        try {
            const [c, p] = await Promise.all([
                axios.get('/api/contacts/?page_size=1000&t='+Date.now()),
                axios.get('/api/products/?status=IN_STOCK&page_size=1000&t='+Date.now())
            ]);
            const contacts = c.data.results || c.data;
            const products = p.data.results || p.data;
            
            document.getElementById('contact_id').innerHTML = '<option value="">请选择...</option>' + contacts.map(i=>`<option value="${i.id}">${i.name}</option>`).join('');
            document.getElementById('product_id').innerHTML = '<option value="">请选择...</option>' + products.map(i=>`<option value="${i.id}">[${i.zencode}] ${i.name} (¥${i.cost_price})</option>`).join('');
        } catch(e) { alert('数据加载失败'); }
    }
    init();

    window.showAddModal = () => document.getElementById('addModal').classList.remove('hidden');
    
    async function addC() {
        try {
            const res = await axios.post('/api/contacts/', { 
                name: document.getElementById('newCName').value, 
                phone: document.getElementById('newCPhone').value,
                address: document.getElementById('newCAddr').value
            });
            const sel = document.getElementById('contact_id');
            const opt = document.createElement('option');
            opt.value = res.data.id; opt.text = res.data.name; opt.selected = true;
            sel.appendChild(opt);
            document.getElementById('addModal').classList.add('hidden');
        } catch(e) { alert('添加失败'); }
    }

    async function submitForm() {
        const data = {
            contact_id: document.getElementById('contact_id').value,
            product_id: document.getElementById('product_id').value,
            start_date: document.getElementById('start_date').value,
            duration: document.getElementById('duration').value,
            deposit: document.getElementById('deposit').value || 0,
            rent_price: document.getElementById('rent_price').value,
            rent_strategy: 'MONTHLY',
            depreciation_monthly: document.getElementById('depreciation').value || 0
        };
        if(!data.contact_id || !data.product_id) return alert('请选择客户和设备');
        try {
            await axios.post('/api/rentals/create_lease/', data);
            alert('开单成功'); window.location.href='/rental/';
        } catch(e) { alert('失败'); }
    }
</script>
{% endblock %}
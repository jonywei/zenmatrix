{% extends 'base.html' %}
{% block title %}é”€å”®å¼€å•{% endblock %}
{% block content %}

<div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-visible" x-data="salesForm()">
    <div class="p-6 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
        <h2 class="text-lg font-bold text-gray-800">âœ¨ å•†å“é”€å”®å‡ºåº“ (æ™ºèƒ½ç‰ˆ)</h2>
        <span class="text-xs text-gray-400" x-text="loading ? 'æ•°æ®åŠ è½½ä¸­...' : 'å‡†å¤‡å°±ç»ª'"></span>
    </div>

    <div class="p-6 space-y-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            
            <div class="relative z-30">
                <label class="block text-sm font-bold text-gray-700 mb-2">é€‰æ‹©å®¢æˆ·</label>
                <div class="flex gap-2 h-12"> <div class="relative w-full h-full" @click.away="closeContactDropdown()">
                        <input 
                            type="text" 
                            x-model="searchContact"
                            @focus="contactOpen = true"
                            @input="contactOpen = true"
                            placeholder="è¾“å…¥å§“åæˆ–ç”µè¯æœç´¢..."
                            class="w-full h-full border border-gray-200 rounded-xl px-4 bg-gray-50 focus:bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition"
                        >
                        <div x-show="contactOpen" class="absolute left-0 right-0 mt-2 bg-white border border-gray-100 rounded-xl shadow-xl max-h-60 overflow-y-auto z-50" style="display: none;">
                            <template x-for="c in filteredContacts" :key="c.id">
                                <div @click="selectContact(c)" class="px-4 py-3 hover:bg-blue-50 cursor-pointer border-b border-gray-50 last:border-0 group">
                                    <div class="flex justify-between items-center">
                                        <span class="font-bold text-gray-800" x-text="c.name"></span>
                                        <span class="text-xs text-gray-400 group-hover:text-blue-500" x-text="c.address || 'æ— åœ°å€'"></span>
                                    </div>
                                    <div class="text-xs text-gray-400 mt-0.5" x-text="c.phone || 'æ— ç”µè¯'"></div>
                                </div>
                            </template>
                            <div x-show="filteredContacts.length === 0" class="p-4 text-gray-400 text-center text-sm">æ— åŒ¹é…å®¢æˆ·</div>
                        </div>
                    </div>
                    
                    <button type="button" @click="showAddModal = true" class="w-12 h-full bg-blue-100 text-blue-600 rounded-xl font-bold hover:bg-blue-200 transition text-xl flex items-center justify-center flex-shrink-0 shadow-sm">+</button>
                </div>
            </div>

            <div class="relative z-20">
                <label class="block text-sm font-bold text-gray-700 mb-2">é€‰æ‹©å•†å“ (åœ¨åº“)</label>
                <div class="relative h-12" @click.away="closeProductDropdown()">
                    <input 
                        type="text" 
                        x-model="searchProduct"
                        @focus="productOpen = true"
                        @input="productOpen = true"
                        placeholder="è¾“å…¥å“å / ä¸²ç  / ä»·æ ¼..."
                        class="w-full h-full border border-gray-200 rounded-xl px-4 bg-gray-50 focus:bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition"
                    >
                    <div x-show="productOpen" class="absolute left-0 right-0 mt-2 bg-white border border-gray-100 rounded-xl shadow-xl max-h-60 overflow-y-auto z-50" style="display: none;">
                        <template x-for="p in filteredProducts" :key="p.id">
                            <div @click="selectProduct(p)" class="px-4 py-3 hover:bg-indigo-50 cursor-pointer border-b border-gray-50 last:border-0 group">
                                <div class="flex justify-between">
                                    <span class="font-bold text-gray-800" x-text="p.name"></span>
                                    <span class="text-green-600 font-mono font-bold">Â¥<span x-text="p.cost_price"></span></span>
                                </div>
                                <div class="flex justify-between mt-1">
                                    <span class="text-xs text-gray-400 bg-gray-100 px-1.5 rounded" x-text="p.zencode"></span>
                                    <span class="text-xs text-gray-400">å»ºè®®ä»·: Â¥<span x-text="p.suggested_price || p.cost_price"></span></span>
                                </div>
                            </div>
                        </template>
                        <div x-show="filteredProducts.length === 0" class="p-4 text-gray-400 text-center text-sm">æ— åŒ¹é…å•†å“</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-blue-50 p-6 rounded-2xl border border-blue-100 grid grid-cols-1 md:grid-cols-3 gap-6">
            <div>
                <label class="block text-xs font-bold text-blue-800 mb-2">æˆäº¤ä»· (åº”æ”¶)</label>
                <div class="relative">
                    <span class="absolute left-3 top-1/2 -translate-y-1/2 text-blue-300 font-bold">Â¥</span>
                    <input type="number" x-model="form.price" class="w-full h-12 rounded-xl border-blue-200 border pl-8 pr-4 font-bold text-blue-700 text-lg focus:ring-2 focus:ring-blue-500 outline-none transition">
                </div>
            </div>
            <div>
                <label class="block text-xs font-bold text-blue-800 mb-2">å®æ”¶é‡‘é¢</label>
                <div class="relative">
                    <span class="absolute left-3 top-1/2 -translate-y-1/2 text-green-300 font-bold">Â¥</span>
                    <input type="number" x-model="form.received_amount" class="w-full h-12 rounded-xl border-blue-200 border pl-8 pr-4 font-bold text-green-700 text-lg focus:ring-2 focus:ring-green-500 outline-none transition">
                </div>
            </div>
            <div>
                <label class="block text-xs font-bold text-blue-800 mb-2">æ”¶æ¬¾è´¦æˆ·</label>
                <div class="relative">
                    <select x-model="form.account_id" class="w-full h-12 rounded-xl border-blue-200 border px-4 text-sm bg-white focus:ring-2 focus:ring-blue-500 outline-none transition appearance-none">
                        <template x-for="acc in accounts" :key="acc.id">
                            <option :value="acc.id" x-text="acc.name"></option>
                        </template>
                    </select>
                    <div class="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-blue-400">â–¼</div>
                </div>
            </div>
        </div>

        <button type="button" @click="submitForm()" :disabled="submitting" class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold hover:bg-blue-700 shadow-lg hover:shadow-xl transition transform active:scale-[0.99] disabled:opacity-50 disabled:cursor-not-allowed">
            <span x-show="!submitting">ç¡®è®¤å‡ºåº“ (Enter)</span>
            <span x-show="submitting">æ­£åœ¨æäº¤...</span>
        </button>
    </div>

    <div x-show="showAddModal" class="fixed inset-0 bg-black bg-opacity-40 z-50 flex items-center justify-center backdrop-blur-sm" style="display: none;" x-transition.opacity>
        <div class="bg-white p-8 rounded-2xl w-full max-w-md shadow-2xl transform transition-all" @click.away="showAddModal = false" x-transition.scale>
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-black text-xl text-gray-800">æ–°å¢å®¢æˆ·æ¡£æ¡ˆ</h3>
                <button @click="showAddModal = false" class="text-gray-400 hover:text-gray-600 transition text-2xl leading-none">&times;</button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">å®¢æˆ·å§“å <span class="text-red-500">*</span></label>
                    <input x-model="newContact.name" class="w-full border border-gray-200 rounded-xl h-12 px-4 bg-gray-50 focus:bg-white focus:ring-2 focus:ring-blue-500 outline-none transition" placeholder="ä¾‹å¦‚ï¼šå¼ ä¸‰">
                </div>
                
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">è”ç³»ç”µè¯</label>
                    <input x-model="newContact.phone" class="w-full border border-gray-200 rounded-xl h-12 px-4 bg-gray-50 focus:bg-white focus:ring-2 focus:ring-blue-500 outline-none transition" placeholder="æ‰‹æœºå· (é€‰å¡«)">
                </div>

                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">æ¡£å£åç§° / åœ°å€</label>
                    <input x-model="newContact.address" class="w-full border border-gray-200 rounded-xl h-12 px-4 bg-gray-50 focus:bg-white focus:ring-2 focus:ring-blue-500 outline-none transition" placeholder="ä¾‹å¦‚ï¼šæ±‰æ­£è¡—Aæ ‹101 (é€‰å¡«)">
                </div>
            </div>

            <div class="flex justify-end gap-3 mt-8">
                <button @click="showAddModal = false" class="px-5 py-2.5 bg-gray-100 rounded-xl text-sm font-bold text-gray-600 hover:bg-gray-200 transition">å–æ¶ˆ</button>
                <button @click="saveNewContact()" class="px-6 py-2.5 bg-blue-600 text-white rounded-xl text-sm font-bold hover:bg-blue-700 shadow-lg hover:shadow-xl transition">ä¿å­˜å¹¶é€‰ä¸­</button>
            </div>
        </div>
    </div>
</div>

<script>
    function salesForm() {
        return {
            loading: true,
            submitting: false,
            
            // æ•°æ®æº
            contacts: [],
            products: [],
            accounts: [],
            
            // æœç´¢çŠ¶æ€
            contactOpen: false,
            searchContact: '',
            
            productOpen: false,
            searchProduct: '',
            
            // è¡¨å•æ•°æ®
            form: {
                contact_id: null,
                product_id: null,
                price: '',
                received_amount: '',
                account_id: null
            },
            
            // æ–°å¢å®¢æˆ·
            showAddModal: false,
            // ğŸŸ¢ è¡¥å…¨å­—æ®µ
            newContact: { name: '', phone: '', address: '' },

            async init() {
                try {
                    const [cRes, pRes, aRes] = await Promise.all([
                        axios.get('/api/contacts/?page_size=1000&t='+Date.now()),
                        axios.get('/api/products/?status=IN_STOCK&page_size=1000&t='+Date.now()),
                        axios.get('/api/analysis/accounting/?t='+Date.now())
                    ]);
                    
                    this.contacts = cRes.data.results || cRes.data;
                    this.products = pRes.data.results || pRes.data;
                    this.accounts = aRes.data.accounts || [];
                    
                    if (this.accounts.length > 0) {
                        this.form.account_id = this.accounts[0].id;
                    }
                } catch (e) {
                    console.error(e);
                    alert("æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢");
                } finally {
                    this.loading = false;
                }
            },

            // æœç´¢é€»è¾‘
            get filteredContacts() {
                if (this.searchContact === '') return this.contacts.slice(0, 10);
                const keyword = this.searchContact.toLowerCase();
                return this.contacts.filter(c => 
                    c.name.toLowerCase().includes(keyword) || 
                    (c.phone && c.phone.includes(keyword)) ||
                    (c.address && c.address.toLowerCase().includes(keyword))
                );
            },

            get filteredProducts() {
                if (this.searchProduct === '') return this.products.slice(0, 10);
                const keyword = this.searchProduct.toLowerCase();
                return this.products.filter(p => 
                    p.name.toLowerCase().includes(keyword) || 
                    (p.zencode && p.zencode.toLowerCase().includes(keyword)) ||
                    String(p.cost_price).includes(keyword)
                );
            },

            selectContact(c) {
                this.form.contact_id = c.id;
                this.searchContact = c.name;
                this.contactOpen = false;
            },
            
            closeContactDropdown() { setTimeout(() => this.contactOpen = false, 200) },

            selectProduct(p) {
                this.form.product_id = p.id;
                this.searchProduct = `[${p.zencode}] ${p.name}`;
                this.form.price = p.suggested_price || p.cost_price;
                this.form.received_amount = this.form.price;
                this.productOpen = false;
            },

            closeProductDropdown() { setTimeout(() => this.productOpen = false, 200) },

            // æ–°å¢å®¢æˆ·æäº¤
            async saveNewContact() {
                if(!this.newContact.name) return alert('è¯·å¡«å†™å§“å');
                try {
                    const res = await axios.post('/api/contacts/', this.newContact);
                    this.contacts.unshift(res.data);
                    this.selectContact(res.data);
                    this.showAddModal = false;
                    this.newContact = { name: '', phone: '', address: '' };
                } catch(e) {
                    alert('æ·»åŠ å¤±è´¥ï¼Œè¯·é‡è¯•');
                }
            },

            async submitForm() {
                if (!this.form.contact_id) return alert("è¯·å…ˆæœç´¢å¹¶é€‰æ‹©ä¸€ä½å®¢æˆ·");
                if (!this.form.product_id) return alert("è¯·å…ˆæœç´¢å¹¶é€‰æ‹©ä¸€ä¸ªå•†å“");
                if (!this.form.price) return alert("è¯·è¾“å…¥æˆäº¤ä»·");

                this.submitting = true;
                try {
                    await axios.post(`/api/products/${this.form.product_id}/sell/`, {
                        contact_id: this.form.contact_id,
                        price: this.form.price,
                        received_amount: this.form.received_amount || 0,
                        account_id: this.form.account_id
                    });
                    alert("âœ… å‡ºåº“æˆåŠŸï¼");
                    window.location.href = '/inventory/';
                } catch (e) {
                    alert("âŒ æäº¤å¤±è´¥: " + (e.response?.data?.detail || "æœªçŸ¥é”™è¯¯"));
                } finally {
                    this.submitting = false;
                }
            }
        }
    }
</script>
{% endblock %}
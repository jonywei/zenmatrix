<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å®¢æˆ·æ¡£æ¡ˆ CRM</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdn.staticfile.net/vue/3.3.4/vue.global.min.js"></script>
    <script src="https://cdn.staticfile.net/axios/1.6.0/axios.min.js"></script>
    <link rel="stylesheet" href="https://cdn.staticfile.net/element-plus/2.3.8/index.min.css" />
    <script src="https://cdn.staticfile.net/element-plus/2.3.8/index.full.min.js"></script>
    
    <style>
        [v-cloak] { display: none; }
        body { background-color: #f3f4f6; font-family: -apple-system, sans-serif; padding-bottom: 50px; }
        .contact-card { transition: all 0.2s; }
        .contact-card:active { transform: scale(0.98); background-color: #f9fafb; }
    </style>
</head>
<body class="p-4 max-w-md mx-auto">
    <div id="app" v-cloak>
        
        <div class="flex items-center justify-between mb-4 sticky top-0 z-10 bg-[#f3f4f6] py-2">
            <div class="flex items-center gap-3">
                <a href="/" class="text-xl font-bold text-gray-500">â†</a>
                <h1 class="text-lg font-bold text-gray-800">å®¢æˆ·æ¡£æ¡ˆ ([[ contacts.length ]])</h1>
            </div>
            <el-button type="primary" circle @click="showAddDialog=true">
                <span class="text-xl font-bold">+</span>
            </el-button>
        </div>

        <div class="bg-white p-3 rounded-2xl shadow-sm mb-4">
            <el-input v-model="keyword" placeholder="ğŸ” æœç´¢å§“å / ç”µè¯..." clearable size="large"></el-input>
        </div>

        <div class="space-y-3">
            <div v-for="c in filteredList" :key="c.id" @click="openDetail(c)" class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex justify-between items-center contact-card cursor-pointer">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-bold">
                        [[ c.name.charAt(0) ]]
                    </div>
                    <div>
                        <div class="font-bold text-gray-800">
                            [[ c.name ]]
                            <span v-if="c.balance < 0" class="ml-1 text-[10px] bg-red-100 text-red-500 px-1 rounded">æ¬ æ¬¾</span>
                        </div>
                        <div class="text-xs text-gray-400 mt-0.5">[[ c.phone || 'æš‚æ— ç”µè¯' ]]</div>
                    </div>
                </div>
                <div class="text-gray-300">â€º</div>
            </div>
            
            <div v-if="filteredList.length === 0" class="p-10 text-center text-gray-400 text-xs">
                æš‚æ— å®¢æˆ·ï¼Œç‚¹å³ä¸Šè§’æ·»åŠ 
            </div>
        </div>

        <el-drawer v-model="showDrawer" :title="current.name" direction="btt" size="90%">
            <div class="p-2 space-y-4">
                
                <div class="bg-gray-50 p-4 rounded-xl space-y-2">
                    <div class="flex justify-between">
                        <span class="text-gray-500 text-xs">ç”µè¯</span>
                        <a :href="'tel:'+current.phone" class="text-blue-600 font-bold text-sm">[[ current.phone || '-' ]] ğŸ“</a>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-500 text-xs">åœ°å€/æ¡£å£</span>
                        <span class="text-gray-800 text-sm">[[ current.address || '-' ]]</span>
                    </div>
                    <div class="flex justify-between items-center pt-2 border-t border-gray-200 mt-2">
                        <span class="text-gray-500 text-xs">å½“å‰ä½™é¢</span>
                        <span class="font-bold text-lg" :class="current.balance > 0 ? 'text-red-500' : 'text-green-500'">
                            [[ current.balance > 0 ? 'æ¬ æˆ‘' : 'æ¬ ä»–' ]] Â¥[[ formatNum(Math.abs(current.balance)) ]]
                        </span>
                    </div>
                </div>

                <el-tabs v-model="activeTab" class="w-full">
                    <el-tab-pane label="äº¤æ˜“è®°å½•" name="history">
                        <el-timeline class="mt-4">
                            <el-timeline-item v-for="h in history" :key="h.id" :timestamp="h.date" placement="top" :color="getColor(h.type)">
                                <div class="bg-white border border-gray-100 p-3 rounded shadow-sm">
                                    <div class="flex justify-between items-center mb-1">
                                        <span class="font-bold text-gray-700">[[ h.type ]]</span>
                                        <span class="font-bold" :class="h.type.includes('æ”¶å…¥')?'text-green-600':'text-gray-800'">
                                            Â¥[[ formatNum(h.amount) ]]
                                        </span>
                                    </div>
                                    <div class="text-xs text-gray-500">å•†å“: [[ h.product ]]</div>
                                    <div class="text-xs text-gray-400 mt-1 bg-gray-50 p-1 rounded">å¤‡æ³¨: [[ h.remark ]]</div>
                                </div>
                            </el-timeline-item>
                        </el-timeline>
                        <div v-if="history.length===0" class="text-center text-gray-300 text-xs py-4">æš‚æ— äº¤æ˜“è®°å½•</div>
                    </el-tab-pane>
                </el-tabs>

            </div>
        </el-drawer>

        <el-dialog v-model="showAddDialog" title="æ–°å»ºæ¡£æ¡ˆ" width="90%" center>
            <div class="space-y-3">
                <el-input v-model="newForm.name" placeholder="å§“å/æ˜µç§° (å¿…å¡«)"></el-input>
                <el-input v-model="newForm.phone" placeholder="è”ç³»ç”µè¯"></el-input>
                <el-input v-model="newForm.address" placeholder="åœ°å€/æ¡£å£å·"></el-input>
            </div>
            <template #footer>
                <el-button @click="showAddDialog = false">å–æ¶ˆ</el-button>
                <el-button type="primary" @click="addContact">ä¿å­˜</el-button>
            </template>
        </el-dialog>

    </div>

    <script>
        const { createApp } = Vue
        const { ElMessage } = ElementPlus
        axios.defaults.headers.common['X-CSRFToken'] = '{{ csrf_token }}';

        createApp({
            data() {
                return {
                    contacts: [], keyword: '',
                    showDrawer: false, showAddDialog: false,
                    current: {}, activeTab: 'history',
                    history: [],
                    newForm: { name: '', phone: '', address: '' }
                }
            },
            computed: {
                filteredList() {
                    if(!this.keyword) return this.contacts;
                    const k = this.keyword.toLowerCase();
                    return this.contacts.filter(c => c.name.toLowerCase().includes(k) || (c.phone && c.phone.includes(k)));
                }
            },
            mounted() { this.loadData(); },
            methods: {
                async loadData() {
                    try {
                        const res = await axios.get('/api/contacts/');
                        this.contacts = res.data.results || res.data;
                    } catch(e) { ElMessage.error('åŠ è½½å¤±è´¥'); }
                },
                async openDetail(c) {
                    this.current = c;
                    this.showDrawer = true;
                    this.history = []; // æ¸…ç©ºæ—§æ•°æ®
                    try {
                        // å¤ç”¨æˆ‘ä»¬åˆšåˆšå†™çš„ history æ¥å£
                        const res = await axios.get(`/api/contacts/${c.id}/history/`);
                        this.history = res.data;
                    } catch(e) {}
                },
                async addContact() {
                    if(!this.newForm.name) return ElMessage.warning('å§“åå¿…å¡«');
                    try {
                        await axios.post('/api/contacts/', this.newForm);
                        ElMessage.success('æ·»åŠ æˆåŠŸ');
                        this.showAddDialog = false;
                        this.newForm = { name: '', phone: '', address: '' };
                        this.loadData();
                    } catch(e) { ElMessage.error('æ·»åŠ å¤±è´¥'); }
                },
                formatNum(num) {
                    return parseFloat(num || 0).toLocaleString();
                },
                getColor(type) {
                    if(type.includes('æ”¶å…¥')) return '#10b981'; // ç»¿
                    if(type.includes('æ”¯å‡º') || type.includes('ä»˜æ¬¾')) return '#ef4444'; // çº¢
                    return '#9ca3af'; // ç°
                }
            },
            compilerOptions: { delimiters: ['[[', ']]'] }
        }).use(ElementPlus).mount('#app');
    </script>
</body>
</html>
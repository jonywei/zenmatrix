{% extends 'base.html' %}
{% block title %}å®¢æˆ·æ¡£æ¡ˆ{% endblock %}
{% block content %}
<div class="flex justify-between items-center mb-6">
    <h1 class="text-2xl font-bold text-gray-800">å®¢æˆ·æ¡£æ¡ˆ</h1>
    <div class="flex gap-2">
        <input type="text" id="so" class="border rounded px-3 py-2 text-sm w-48" placeholder="æœå§“å/ç”µè¯..." oninput="filter()">
        <button onclick="showAddModal()" class="bg-blue-600 text-white px-4 py-2 rounded font-bold text-sm hover:bg-blue-700 shadow">+ æ–°å»º</button>
    </div>
</div>

<div id="list" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>

<div id="detailModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl w-full max-w-3xl max-h-[90vh] flex flex-col shadow-2xl overflow-hidden">
        <div class="px-6 py-4 border-b flex justify-between items-center bg-gray-50">
            <div>
                <h3 class="font-bold text-xl text-gray-800" id="dName">å®¢æˆ·å</h3>
                <p class="text-xs text-gray-500" id="dPhone">ç”µè¯</p>
            </div>
            <button onclick="closeDetail()" class="text-gray-400 hover:text-gray-700 text-3xl">&times;</button>
        </div>
        
        <div class="flex-1 overflow-y-auto p-6">
            <div class="flex gap-4 mb-6">
                <div class="flex-1 bg-blue-50 p-4 rounded-lg border border-blue-100 text-center">
                    <p class="text-xs text-blue-600 mb-1">å½“å‰ä½™é¢</p>
                    <p class="text-2xl font-black" id="dBalance">Â¥0</p>
                    <p class="text-xs text-gray-400 mt-1" id="dStatus">å¹³è¡¡</p>
                </div>
                <div class="flex flex-col gap-2 justify-center">
                    <button onclick="doRepay('in')" class="px-4 py-2 bg-green-600 text-white rounded text-sm font-bold hover:bg-green-700 shadow">æ”¶æ¬¾æ ¸é”€</button>
                    <button onclick="doRepay('out')" class="px-4 py-2 bg-red-100 text-red-600 rounded text-sm font-bold hover:bg-red-200">ä»˜æ¬¾æ ¸é”€</button>
                </div>
            </div>

            <h4 class="font-bold text-gray-700 mb-3 border-l-4 border-purple-500 pl-2">äº¤æ˜“æµæ°´ (å¯¹è´¦å•)</h4>
            <div class="bg-white border rounded-lg overflow-hidden">
                <table class="w-full text-sm text-left">
                    <thead class="bg-gray-50 text-gray-500">
                        <tr>
                            <th class="px-4 py-2">æ—¶é—´</th>
                            <th class="px-4 py-2">ç±»å‹</th>
                            <th class="px-4 py-2">å†…å®¹/å•†å“</th>
                            <th class="px-4 py-2 text-right">é‡‘é¢</th>
                        </tr>
                    </thead>
                    <tbody id="dHistory" class="divide-y">
                        <tr><td colspan="4" class="p-4 text-center text-gray-400">åŠ è½½ä¸­...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <div class="p-4 border-t bg-gray-50 flex justify-between">
            <button class="text-gray-500 text-sm hover:underline">ğŸ–¨ï¸ æ‰“å°å¯¹è´¦å•</button>
            <button onclick="closeDetail()" class="bg-white border border-gray-300 px-6 py-2 rounded font-bold text-gray-700 hover:bg-gray-100">å…³é—­</button>
        </div>
    </div>
</div>

<div id="addModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
    <div class="bg-white p-6 rounded-lg w-80 shadow-lg">
        <h3 class="font-bold mb-4">æ–°å¢å®¢æˆ·</h3>
        <input id="cName" class="w-full border rounded h-10 px-3 mb-3" placeholder="å§“å (å¿…å¡«)">
        <input id="cPhone" class="w-full border rounded h-10 px-3 mb-3" placeholder="ç”µè¯">
        <input id="cAddr" class="w-full border rounded h-10 px-3 mb-4" placeholder="åœ°å€/å¤‡æ³¨">
        <div class="flex justify-end gap-2">
            <button onclick="document.getElementById('addModal').classList.add('hidden')" class="px-4 py-2 bg-gray-100 rounded">å–æ¶ˆ</button>
            <button onclick="add()" class="px-4 py-2 bg-blue-600 text-white rounded">ä¿å­˜</button>
        </div>
    </div>
</div>

<script>
    let all = [];
    let currentId = null;
    let accs = [];

    async function load() {
        const [c, a] = await Promise.all([
            axios.get('/api/contacts/?page_size=1000&t='+Date.now()),
            axios.get('/api/analysis/accounting/?t='+Date.now())
        ]);
        all = c.data.results || c.data;
        accs = a.data.accounts;
        render(all);
    }
    
    function render(list) {
        document.getElementById('list').innerHTML = list.map(c => `
            <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 hover:shadow-md transition cursor-pointer hover:border-blue-300" onclick="openDetail(${c.id})">
                <div class="flex justify-between items-start">
                    <div>
                        <h3 class="font-bold text-lg text-gray-800">${c.name}</h3>
                        <p class="text-sm text-gray-500 mt-1">ğŸ“ ${c.phone||'--'}</p>
                    </div>
                    ${parseFloat(c.balance)!==0 ? `<span class="text-xs font-bold px-2 py-1 rounded ${c.balance>0?'bg-green-100 text-green-700':'bg-red-100 text-red-700'}">${c.balance>0?'æ¬ æˆ‘':'æˆ‘æ¬ '} ${Math.abs(c.balance)}</span>` : ''}
                </div>
                <div class="mt-3 pt-3 border-t border-gray-50 flex justify-between items-center text-xs text-gray-400">
                    <span>${c.address || 'æ— åœ°å€'}</span>
                    <span class="text-blue-600">æŸ¥çœ‹è¯¦æƒ… â€º</span>
                </div>
            </div>`).join('');
    }

    async function openDetail(id) {
        const c = all.find(i => i.id === id);
        if(!c) return;
        currentId = id;
        
        document.getElementById('dName').innerText = c.name;
        document.getElementById('dPhone').innerText = c.phone || 'æ— ç”µè¯';
        const bal = parseFloat(c.balance);
        document.getElementById('dBalance').innerText = 'Â¥' + Math.abs(bal).toLocaleString();
        document.getElementById('dBalance').className = `text-2xl font-black ${bal>0?'text-green-600':(bal<0?'text-red-600':'text-gray-800')}`;
        document.getElementById('dStatus').innerText = bal>0 ? 'å¯¹æ–¹æ¬ æ¬¾ (åº”æ”¶)' : (bal<0 ? 'æˆ‘æ–¹æ¬ æ¬¾ (åº”ä»˜)' : 'è´¦ç›®å¹³è¡¡');
        
        document.getElementById('detailModal').classList.remove('hidden');
        
        // æ‹‰å–æµæ°´
        try {
            const res = await axios.get(`/api/contacts/${id}/history/?t=`+Date.now());
            const txs = res.data;
            const tbody = document.getElementById('dHistory');
            if(txs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-gray-400">æ— äº¤æ˜“è®°å½•</td></tr>';
            } else {
                tbody.innerHTML = txs.map(t => {
                    const isPlus = t.type === 'SALE' || t.type === 'RENT'; // ç®€å•é€»è¾‘ï¼Œå®é™…çœ‹é‡‘é¢
                    // é‡‘é¢æ˜¾ç¤ºé€»è¾‘ï¼šå¦‚æœæ˜¯æ ¸é”€ï¼Œçœ‹æ–¹å‘
                    return `<tr class="hover:bg-gray-50">
                        <td class="px-4 py-2 text-gray-500 text-xs">${t.date}</td>
                        <td class="px-4 py-2"><span class="bg-gray-100 px-2 py-0.5 rounded text-xs font-bold text-gray-600">${t.type}</span></td>
                        <td class="px-4 py-2 text-gray-700 font-medium">${t.product || t.remark}</td>
                        <td class="px-4 py-2 text-right font-mono font-bold">Â¥${parseFloat(t.amount).toLocaleString()}</td>
                    </tr>`;
                }).join('');
            }
        } catch(e) { document.getElementById('dHistory').innerHTML = '<tr><td colspan="4">åŠ è½½å¤±è´¥</td></tr>'; }
    }

    async function doRepay(type) {
        if(!accs.length) return alert("è¯·å…ˆåœ¨[èµ„é‡‘è´¦æˆ·]ä¸­åˆ›å»ºè´¦æˆ·");
        const amt = prompt("è¯·è¾“å…¥æ ¸é”€é‡‘é¢:");
        if(!amt) return;
        try {
            await axios.post(`/api/contacts/${currentId}/repay/`, {
                amount: amt,
                account_id: accs[0].id, // é»˜è®¤ç¬¬ä¸€ä¸ªï¼Œå¯æ‰©å±•é€‰æ‹©
                action_type: type
            });
            alert("æ ¸é”€æˆåŠŸ");
            closeDetail();
            load(); // åˆ·æ–°åˆ—è¡¨
        } catch(e) { alert("æ“ä½œå¤±è´¥"); }
    }

    function closeDetail() { document.getElementById('detailModal').classList.add('hidden'); }
    function filter() { const k=document.getElementById('so').value; render(all.filter(i=>i.name.includes(k))); }
    window.showAddModal = () => document.getElementById('addModal').classList.remove('hidden');
    async function add() {
        try {
            await axios.post('/api/contacts/', {
                name: document.getElementById('cName').value,
                phone: document.getElementById('cPhone').value,
                address: document.getElementById('cAddr').value
            });
            alert('æ·»åŠ æˆåŠŸ'); document.getElementById('addModal').classList.add('hidden'); load();
        } catch(e) { alert('å¤±è´¥'); }
    }
    
    load();
</script>
{% endblock %}
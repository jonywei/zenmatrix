{% extends 'base.html' %}
{% block title %}åº“å­˜ç®¡ç†{% endblock %}
{% block content %}
<div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
    <h1 class="text-2xl font-bold text-gray-800 border-l-4 border-orange-500 pl-3">åº“å­˜æ¸…å•</h1>
    <div class="flex gap-2 w-full md:w-auto">
        <select id="statusFilter" class="border rounded px-3 py-2 text-sm bg-white font-bold text-blue-600" onchange="loadData()">
            <option value="ALL">ğŸ“¦ å…¨éƒ¨èµ„äº§ (åœ¨åº“+å¤–å€Ÿ)</option>
            <option value="IN_STOCK">ğŸ  ä»…çœ‹åœ¨åº“</option>
            <option value="RENTED">ğŸšš ä»…çœ‹å¤–å€Ÿ/åœ¨ç§Ÿ</option>
        </select>
        <select id="catFilter" class="border rounded px-3 py-2 text-sm bg-white" onchange="filterList()">
            <option value="">ğŸ“‚ å…¨éƒ¨åˆ†ç±»</option>
            <option value="ZJ">ğŸ–¥ï¸ æ•´æœº</option>
            <option value="XS">ğŸ“º æ˜¾ç¤ºå™¨</option>
            <option value="SJ">ğŸ”Œ æ•£ä»¶</option>
            <option value="ZX">ğŸ“¦ æ‚é¡¹</option>
        </select>
        <input type="text" id="searchInput" placeholder="æœç´¢å‹å·/ç¼–ç ..." class="border rounded px-3 py-2 text-sm w-full md:w-64" oninput="filterList()">
        <a href="/entry/" class="bg-green-600 text-white px-4 py-2 rounded text-sm font-bold hover:bg-green-700 whitespace-nowrap">+ å…¥åº“</a>
    </div>
</div>

<div class="bg-white rounded-xl shadow-sm overflow-hidden">
    <div class="overflow-x-auto">
        <table class="w-full text-left text-sm whitespace-nowrap">
            <thead class="bg-gray-50 text-gray-500 border-b">
                <tr>
                    <th class="px-6 py-3">å›¾ç‰‡</th>
                    <th class="px-6 py-3">çŠ¶æ€/é¢„è­¦</th>
                    <th class="px-6 py-3">å•†å“åç§° / é…ç½®</th>
                    <th class="px-6 py-3">æˆæœ¬</th>
                    <th class="px-6 py-3">å…¥åº“æ—¶é—´</th>
                </tr>
            </thead>
            <tbody id="tbody" class="divide-y divide-gray-50">
                <tr><td colspan="5" class="px-6 py-8 text-center text-gray-400">åŠ è½½ä¸­...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<div id="flowModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
    <div class="bg-white rounded-xl w-full max-w-lg p-6 m-4 shadow-2xl">
        <h3 class="font-bold text-lg mb-4 text-gray-800">ğŸ“¦ èµ„äº§æµè½¬è®°å½•</h3>
        <div id="flowContent" class="space-y-4 max-h-[60vh] overflow-y-auto"></div>
        <button onclick="document.getElementById('flowModal').classList.add('hidden')" class="mt-6 w-full py-2 bg-gray-100 rounded text-gray-600 font-bold">å…³é—­</button>
    </div>
</div>

<script>
    let allData = [];
    const catMap = { 'ZJ': 'æ•´æœº', 'XS': 'æ˜¾ç¤ºå™¨', 'SJ': 'æ•£ä»¶', 'ZX': 'æ‚é¡¹' };
    const statusMap = { 'IN_STOCK': 'åœ¨åº“', 'RENTED': 'åœ¨ç§Ÿ', 'TRANSIT': 'ä¸­è½¬', 'SOLD': 'å·²å”®' };
    
    // ğŸŸ¢ é¢œè‰²é€»è¾‘å¯¹åº”
    const colorClass = {
        'green': 'bg-green-100 text-green-700 border-green-200',
        'yellow': 'bg-yellow-100 text-yellow-700 border-yellow-200',
        'red': 'bg-red-100 text-red-700 border-red-200'
    };

    async function loadData() {
        const status = document.getElementById('statusFilter').value;
        try {
            // ğŸŸ¢ é»˜è®¤æŸ¥å…¨éƒ¨
            const res = await axios.get(`/api/products/?status=${status}&page_size=1000&t=` + Date.now());
            allData = res.data.results || res.data;
            renderList(allData);
        } catch (err) {
            document.getElementById('tbody').innerHTML = '<tr><td colspan="5" class="text-center py-4 text-red-500">åŠ è½½å¤±è´¥</td></tr>';
        }
    }

    function renderList(list) {
        const tbody = document.getElementById('tbody');
        if (list.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center py-10 text-gray-400">æš‚æ— æ•°æ®</td></tr>';
            return;
        }
        tbody.innerHTML = list.map(item => {
            const badgeClass = colorClass[item.color_tag] || 'bg-gray-100 text-gray-600';
            const statusText = statusMap[item.status] || item.status;
            const imgSrc = item.image ? item.image : 'https://via.placeholder.com/100x100?text=No+Img';
            
            return `
            <tr class="hover:bg-gray-50 transition cursor-pointer" onclick="showFlow(${item.id})">
                <td class="px-6 py-4">
                    <div class="w-12 h-12 bg-gray-100 rounded overflow-hidden border border-gray-200">
                        <img src="${imgSrc}" class="w-full h-full object-cover">
                    </div>
                </td>
                <td class="px-6 py-4">
                    <span class="px-2 py-1 rounded text-xs border font-bold ${badgeClass}">${statusText}</span>
                    <div class="font-mono text-xs text-gray-400 mt-1">${item.zencode}</div>
                </td>
                <td class="px-6 py-4">
                    <div class="font-bold text-gray-800 text-base">${item.name}</div>
                    <div class="text-xs text-gray-500 mt-1 truncate max-w-xs">${item.cpu || ''} ${item.gpu || ''} ${item.ram || ''}</div>
                </td>
                <td class="px-6 py-4 font-bold text-orange-600">Â¥${parseFloat(item.cost_price).toLocaleString()}</td>
                <td class="px-6 py-4 text-gray-400 text-xs">${item.created_at.split('T')[0]}</td>
            </tr>
            `;
        }).join('');
    }

    async function showFlow(id) {
        const item = allData.find(i => i.id === id);
        if(!item) return;
        
        const flowDiv = document.getElementById('flowContent');
        flowDiv.innerHTML = '<p class="text-center text-gray-400">åŠ è½½ä¸­...</p>';
        document.getElementById('flowModal').classList.remove('hidden');
        
        try {
            // ğŸŸ¢ å‰ç«¯ç›´æ¥åˆ©ç”¨å·²æœ‰çš„æ•°æ® (å¦‚æœåç«¯å·²åœ¨listè¿”å›flow) æˆ–é‡æ–°è¯·æ±‚
            // è¿™é‡Œä¸ºäº†ä¿é™©ï¼Œæˆ‘ä»¬å¯ä»¥è¯·æ±‚è¯¦æƒ…æˆ–è€…ç›´æ¥è§£æ
            // å¦‚æœåˆ—è¡¨æ¥å£æ²¡å¸¦flow_historyï¼Œéœ€è¦è¯·æ±‚è¯¦æƒ…:
            const res = await axios.get(`/api/products/${id}/`);
            const flow = res.data.flow_history;
            
            if(!flow || flow.length === 0) {
                flowDiv.innerHTML = '<p class="text-center text-gray-400">æš‚æ— æµè½¬è®°å½•</p>';
                return;
            }
            
            flowDiv.innerHTML = flow.map((f, i) => `
                <div class="flex gap-3 relative pb-4 ${i===flow.length-1?'':'border-l-2 border-gray-100 ml-2'}">
                    <div class="w-4 h-4 rounded-full bg-blue-500 -ml-[9px] mt-1 border-2 border-white ring-2 ring-blue-100"></div>
                    <div>
                        <p class="text-xs text-gray-400">${f.date} <span class="ml-2 font-bold text-gray-600">${f.operator}</span></p>
                        <p class="font-bold text-gray-800 mt-1">${f.type}</p>
                        <p class="text-sm text-gray-500 bg-gray-50 p-2 rounded mt-1">${f.desc}</p>
                    </div>
                </div>
            `).join('');
            
        } catch(e) { flowDiv.innerHTML = '<p class="text-red-500 text-center">åŠ è½½å¤±è´¥</p>'; }
    }

    function filterList() {
        const keyword = document.getElementById('searchInput').value.toLowerCase();
        const cat = document.getElementById('catFilter').value;
        const filtered = allData.filter(i => {
            return ((i.name && i.name.toLowerCase().includes(keyword)) || (i.zencode && i.zencode.toLowerCase().includes(keyword))) && (cat === '' || i.category === cat);
        });
        renderList(filtered);
    }

    loadData();
</script>
{% endblock %}
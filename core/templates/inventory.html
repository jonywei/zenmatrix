{% extends 'base.html' %}
{% block title %}åº“å­˜ç®¡ç†{% endblock %}
{% block content %}
<div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
    <h1 class="text-2xl font-bold text-gray-800 border-l-4 border-orange-500 pl-3">åº“å­˜æ¸…å•</h1>
    <div class="flex gap-2 w-full md:w-auto">
        <select id="catFilter" class="border rounded px-3 py-2 text-sm bg-white" onchange="filterList()">
            <option value="">ğŸ“‚ å…¨éƒ¨åˆ†ç±»</option>
            <option value="ZJ">ğŸ–¥ï¸ æ•´æœº</option>
            <option value="XS">ğŸ“º æ˜¾ç¤ºå™¨</option>
            <option value="SJ">ğŸ”Œ æ•£ä»¶</option>
            <option value="ZX">ğŸ“¦ æ‚é¡¹</option>
        </select>
        <input type="text" id="searchInput" placeholder="æœç´¢å‹å·/ç¼–ç ..." class="border rounded px-3 py-2 text-sm w-full md:w-64" oninput="filterList()">
        <a href="/entry/" class="bg-green-600 text-white px-4 py-2 rounded text-sm font-bold hover:bg-green-700 whitespace-nowrap">+ å…¥åº“</a>
    </div>
</div>

<div class="bg-white rounded-xl shadow-sm overflow-hidden">
    <div class="overflow-x-auto">
        <table class="w-full text-left text-sm whitespace-nowrap">
            <thead class="bg-gray-50 text-gray-500 border-b">
                <tr>
                    <th class="px-6 py-3">å›¾ç‰‡</th>
                    <th class="px-6 py-3">ZenCode / åˆ†ç±»</th>
                    <th class="px-6 py-3">å•†å“åç§° / é…ç½®</th>
                    <th class="px-6 py-3">æˆæœ¬</th>
                    <th class="px-6 py-3">å…¥åº“æ—¶é—´</th>
                </tr>
            </thead>
            <tbody id="tbody" class="divide-y divide-gray-50">
                <tr><td colspan="5" class="px-6 py-8 text-center text-gray-400">åŠ è½½ä¸­...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<script>
    let allData = [];
    const catMap = { 'ZJ': 'æ•´æœº', 'XS': 'æ˜¾ç¤ºå™¨', 'SJ': 'æ•£ä»¶', 'ZX': 'æ‚é¡¹' };
    const catColor = { 'ZJ': 'bg-blue-100 text-blue-700', 'XS': 'bg-purple-100 text-purple-700', 'SJ': 'bg-gray-100 text-gray-700', 'ZX': 'bg-yellow-100 text-yellow-700' };

    async function loadData() {
        try {
            const res = await axios.get('/api/products/?status=IN_STOCK&page_size=1000&t=' + Date.now());
            allData = res.data.results || res.data;
            renderList(allData);
        } catch (err) {
            document.getElementById('tbody').innerHTML = '<tr><td colspan="5" class="text-center py-4 text-red-500">åŠ è½½å¤±è´¥</td></tr>';
        }
    }

    function renderList(list) {
        const tbody = document.getElementById('tbody');
        if (list.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center py-10 text-gray-400">æš‚æ— åº“å­˜</td></tr>';
            return;
        }
        tbody.innerHTML = list.map(item => {
            const badgeClass = catColor[item.category] || 'bg-gray-100 text-gray-600';
            const catName = catMap[item.category] || item.category;
            const imgSrc = item.image ? item.image : 'https://via.placeholder.com/100x100?text=No+Img';
            
            return `
            <tr class="hover:bg-gray-50 transition group">
                <td class="px-6 py-4">
                    <div class="w-12 h-12 bg-gray-100 rounded overflow-hidden border border-gray-200">
                        <img src="${imgSrc}" class="w-full h-full object-cover group-hover:scale-110 transition">
                    </div>
                </td>
                <td class="px-6 py-4">
                    <div class="font-mono text-blue-600 font-bold">${item.zencode}</div>
                    <span class="text-xs px-2 py-0.5 rounded ${badgeClass}">${catName}</span>
                </td>
                <td class="px-6 py-4">
                    <div class="font-bold text-gray-800 text-base">${item.name}</div>
                    <div class="text-xs text-gray-500 mt-1 truncate max-w-xs">${item.cpu || ''} ${item.gpu || ''} ${item.ram || ''} ${item.note || ''}</div>
                </td>
                <td class="px-6 py-4 font-bold text-orange-600">Â¥${parseFloat(item.cost_price).toLocaleString()}</td>
                <td class="px-6 py-4 text-gray-400 text-xs">${item.created_at.split('T')[0]}</td>
            </tr>
            `;
        }).join('');
    }

    function filterList() {
        const keyword = document.getElementById('searchInput').value.toLowerCase();
        const cat = document.getElementById('catFilter').value;
        
        const filtered = allData.filter(i => {
            const matchKey = (i.name && i.name.toLowerCase().includes(keyword)) || (i.zencode && i.zencode.toLowerCase().includes(keyword));
            const matchCat = cat === '' || i.category === cat;
            return matchKey && matchCat;
        });
        renderList(filtered);
    }

    loadData();
</script>
{% endblock %}
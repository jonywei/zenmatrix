{% extends 'base.html' %}

{% block title %}经营概览{% endblock %}

{% block content %}
<div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
    <div class="bg-blue-600 rounded-xl p-5 text-white shadow-lg">
        <p class="text-blue-200 text-xs font-bold mb-1">当前库存货值</p>
        <p class="text-3xl font-black">¥<span id="stockVal">0</span></p>
    </div>
    <div class="bg-white rounded-xl p-5 border border-gray-100 shadow-sm">
        <p class="text-gray-400 text-xs font-bold mb-1">全平台销售总额</p>
        <p class="text-3xl font-black text-gray-800">¥<span id="totalSales">0</span></p>
    </div>
    <div class="bg-white rounded-xl p-5 border border-gray-100 shadow-sm">
        <p class="text-gray-400 text-xs font-bold mb-1">待收回款 (应收)</p>
        <p class="text-3xl font-black text-green-600">¥<span id="receivable">0</span></p>
    </div>
    <div class="bg-white rounded-xl p-5 border border-gray-100 shadow-sm">
        <p class="text-gray-400 text-xs font-bold mb-1">待付账款 (应付)</p>
        <p class="text-3xl font-black text-red-500">¥<span id="payable">0</span></p>
    </div>
</div>

<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
    <div class="md:col-span-2 bg-white p-6 rounded-xl shadow-sm border border-gray-100">
        <h3 class="font-bold text-gray-800 mb-4 border-l-4 border-blue-500 pl-3">近7天销售走势</h3>
        <div class="h-64">
            <canvas id="trendChart"></canvas>
        </div>
    </div>
    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
        <h3 class="font-bold text-gray-800 mb-4 border-l-4 border-purple-500 pl-3">销售品类占比</h3>
        <div class="h-64 flex justify-center">
            <canvas id="catChart"></canvas>
        </div>
    </div>
</div>

<div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
    <div class="px-6 py-4 border-b border-gray-50 flex justify-between items-center bg-gray-50/50">
        <h3 class="font-bold text-gray-800">最近动态 (实时)</h3>
        <span class="text-xs text-green-600 bg-green-50 px-2 py-1 rounded-full animate-pulse">● Live</span>
    </div>
    <div id="activityList" class="divide-y divide-gray-50">
        <div class="p-6 text-center text-gray-400 text-sm">加载中...</div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    function fmt(n) { return parseFloat(n || 0).toLocaleString('zh-CN', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); }

    async function loadData() {
        try {
            const res = await axios.get('/api/analysis/dashboard/?t=' + Date.now());
            const d = res.data.cards;
            const charts = res.data.charts;
            const list = res.data.recent_list;

            // 1. 填充卡片
            document.getElementById('stockVal').innerText = fmt(d.stock_val);
            document.getElementById('totalSales').innerText = fmt(d.total_sales_amount);
            document.getElementById('receivable').innerText = fmt(d.receivable);
            document.getElementById('payable').innerText = fmt(d.payable);

            // 2. 渲染折线图
            new Chart(document.getElementById('trendChart'), {
                type: 'line',
                data: {
                    labels: charts.trend.labels,
                    datasets: [{
                        label: '销售额',
                        data: charts.trend.data,
                        borderColor: '#2563eb',
                        backgroundColor: 'rgba(37, 99, 235, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: { maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });

            // 3. 渲染饼图
            new Chart(document.getElementById('catChart'), {
                type: 'doughnut',
                data: {
                    labels: charts.category.labels,
                    datasets: [{
                        data: charts.category.data,
                        backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#6366f1']
                    }]
                },
                options: { maintainAspectRatio: false }
            });

            // 4. 渲染列表 (保持原有逻辑)
            const el = document.getElementById('activityList');
            if (!list || list.length === 0) {
                el.innerHTML = '<div class="p-8 text-center text-gray-400">暂无动态</div>';
                return;
            }
            el.innerHTML = list.map(item => {
                const hasMoney = Math.abs(parseFloat(item.amount)) > 0.01;
                let rightHtml = hasMoney 
                    ? `<span class="font-mono font-bold ${item.is_income ? 'text-red-500' : 'text-green-600'}">${item.is_income ? '+' : '-'}${fmt(item.amount)}</span>`
                    : `<span class="bg-gray-100 text-gray-600 text-xs px-2 py-1 rounded font-bold">${item.action_type || '业务'}</span>`;
                return `<div class="px-6 py-4 flex justify-between items-center hover:bg-gray-50 transition">
                    <div><p class="font-bold text-gray-800 text-sm mb-1">${item.change_message || item.desc}</p><p class="text-xs text-gray-400">${item.time}</p></div>
                    <div>${rightHtml}</div></div>`;
            }).join('');

        } catch (e) { console.error("加载失败", e); }
    }
    loadData();
</script>
{% endblock %}
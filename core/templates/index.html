<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ZenMatrix å·¥ä½œå°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.staticfile.net/vue/3.3.4/vue.global.min.js"></script>
    <script src="https://cdn.staticfile.net/axios/1.6.0/axios.min.js"></script>
    <style>[v-cloak]{display:none} body{padding-bottom: 100px;}</style>
</head>
<body class="bg-gray-50 min-h-screen font-sans">
    <div id="app" v-cloak>
        
        <div class="bg-white px-6 pt-8 pb-4 mb-4 shadow-sm flex justify-between items-center sticky top-0 z-20">
            <h1 class="text-2xl font-black text-gray-900 tracking-tight">ZenMatrix</h1>
            <a href="/profile/" class="w-10 h-10 bg-blue-50 rounded-full flex items-center justify-center text-blue-600 font-bold border border-blue-100 shadow-sm">
                {{ user.initials|default:"WZ" }}
            </a>
        </div>

        <div class="px-4 space-y-4">
            
            <div class="bg-blue-600 rounded-2xl p-5 text-white shadow-lg shadow-blue-200 relative overflow-hidden">
                <div class="relative z-10">
                    <div class="text-blue-100 text-xs font-bold mb-2">å½“å‰åº“å­˜æ€»è´§å€¼ (æˆæœ¬)</div>
                    
                    <div class="flex justify-between items-end">
                        <div class="text-3xl font-black mb-1">
                            Â¥ [[ formatNum(data.stock_value) ]]
                        </div>

                        <div class="flex gap-2">
                            <div class="bg-white/10 rounded-lg p-2 text-center min-w-[72px] backdrop-blur-sm border border-white/10">
                                <div class="text-[10px] text-blue-100 mb-0.5">ä»Šæ—¥å…¥åº“</div>
                                <div class="font-bold text-lg leading-tight">[[ data.today_entry ]]</div>
                            </div>
                            <div class="bg-white/10 rounded-lg p-2 text-center min-w-[72px] backdrop-blur-sm border border-white/10">
                                <div class="text-[10px] text-blue-100 mb-0.5">ä»Šæ—¥é”€å”®</div>
                                <div class="font-bold text-lg leading-tight">[[ data.today_sale ]]</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="absolute -right-6 -top-10 w-32 h-32 bg-white/10 rounded-full blur-2xl"></div>
            </div>

            <div class="grid grid-cols-4 gap-3">
                <a href="/contact/" class="bg-white p-3 rounded-xl shadow-sm flex flex-col items-center justify-center gap-2 active:scale-95 transition h-24">
                    <span class="text-2xl text-purple-600">ğŸ‘¥</span>
                    <span class="text-xs font-bold text-gray-700">å®¢æˆ·</span>
                </a>
                <a href="/inventory/" class="bg-white p-3 rounded-xl shadow-sm flex flex-col items-center justify-center gap-2 active:scale-95 transition h-24">
                    <span class="text-2xl text-orange-500">ğŸ“¦</span>
                    <span class="text-xs font-bold text-gray-700">åº“å­˜</span>
                </a>
                <a href="/rental/" class="bg-white p-3 rounded-xl shadow-sm flex flex-col items-center justify-center gap-2 active:scale-95 transition h-24">
                    <span class="text-2xl text-blue-500">ğŸ”„</span>
                    <span class="text-xs font-bold text-gray-700">ç§Ÿèµ</span>
                </a>
                <a href="/analysis/account/" class="bg-white p-3 rounded-xl shadow-sm flex flex-col items-center justify-center gap-2 active:scale-95 transition h-24">
                    <span class="text-2xl text-indigo-500">ğŸ¦</span>
                    <span class="text-xs font-bold text-gray-700">èµ„é‡‘</span>
                </a>
            </div>

            <div class="grid grid-cols-2 gap-3">
                <a href="/analysis/profit/" class="bg-white p-4 rounded-xl shadow-sm flex items-center gap-3 active:bg-gray-50">
                    <div class="w-10 h-10 rounded-lg bg-yellow-50 text-yellow-600 flex items-center justify-center text-xl">ğŸ“ˆ</div>
                    <div>
                        <div class="text-sm font-bold text-gray-800">åˆ©æ¶¦æŠ¥è¡¨</div>
                        <div class="text-[10px] text-gray-400">æŸ¥çœ‹æ¯›åˆ©</div>
                    </div>
                </a>
                <a href="/analysis/finance/" class="bg-white p-4 rounded-xl shadow-sm flex items-center gap-3 active:bg-gray-50">
                    <div class="w-10 h-10 rounded-lg bg-red-50 text-red-600 flex items-center justify-center text-xl">ğŸ’°</div>
                    <div>
                        <div class="text-sm font-bold text-gray-800">æ¬ æ¬¾å¾€æ¥</div>
                        <div class="text-[10px] text-gray-400">åº”æ”¶åº”ä»˜</div>
                    </div>
                </a>
            </div>

            <div>
                <h3 class="text-xs font-bold text-gray-400 mb-3 ml-1">æœ€è¿‘åŠ¨æ€</h3>
                <div v-if="data.recent_list && data.recent_list.length > 0" class="bg-white rounded-xl shadow-sm border border-gray-100 divide-y divide-gray-50">
                    <div v-for="item in data.recent_list" :key="item.id" class="p-4 flex justify-between items-center">
                        <div>
                            <div class="font-bold text-gray-800 text-sm truncate w-48">[[ item.desc ]]</div>
                            <div class="text-[10px] text-gray-400 mt-1">[[ item.time ]]</div>
                        </div>
                        <div class="font-bold text-sm font-mono" :class="item.is_income ? 'text-red-500' : 'text-green-600'">
                            [[ item.is_income ? '+' : '-' ]] [[ formatNum(item.amount) ]]
                        </div>
                    </div>
                </div>
                <div v-else class="text-center py-8 text-gray-300 text-xs bg-white rounded-xl">
                    æš‚æ— åŠ¨æ€
                </div>
            </div>

        </div>
        
        <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-100 p-4 pb-6 z-30 flex gap-4 shadow-[0_-4px_20px_rgba(0,0,0,0.03)] max-w-md mx-auto">
            <a href="/entry/" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold py-3.5 rounded-xl flex items-center justify-center gap-2 transition active:scale-95">
                <span class="text-lg">ğŸ“¥</span> å¿«é€Ÿå…¥åº“
            </a>
            <a href="/sales/" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3.5 rounded-xl flex items-center justify-center gap-2 shadow-lg shadow-blue-200 active:scale-95 transition">
                <span class="text-lg">ğŸ’¸</span> ç«‹å³å¼€å•
            </a>
        </div>

    </div>

    <script>
        const { createApp } = Vue
        axios.defaults.headers.common['X-CSRFToken'] = '{{ csrf_token }}';

        createApp({
            data() {
                return {
                    // åˆå§‹åŒ–æ•°æ®ç»“æ„
                    data: { stock_value: 0, stock_count: 0, today_entry: 0, today_sale: 0, recent_list: [] }
                }
            },
            mounted() {
                this.loadData();
                // ç›‘å¬è¿”å›ï¼Œè‡ªåŠ¨åˆ·æ–°
                document.addEventListener("visibilitychange", () => {
                    if (document.visibilityState === 'visible') this.loadData();
                });
            },
            methods: {
                async loadData() {
                    try {
                        const res = await axios.get('/api/analysis/dashboard/');
                        this.data = res.data;
                    } catch(e) { console.error('æ•°æ®åŠ è½½å¤±è´¥', e); }
                },
                formatNum(num) {
                    return parseFloat(num || 0).toLocaleString('zh-CN', {minimumFractionDigits: 2});
                }
            },
            compilerOptions: { delimiters: ['[[', ']]'] }
        }).mount('#app');
    </script>
</body>
</html>
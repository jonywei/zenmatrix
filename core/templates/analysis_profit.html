{% extends 'base.html' %}
{% block title %}利润战报{% endblock %}
{% block content %}
<div class="bg-white rounded-xl shadow-sm p-6 mb-6">
    <div class="flex flex-col md:flex-row md:items-end gap-4">
        <div><label class="block text-xs font-bold text-gray-500 mb-1">开始日期</label><input type="date" id="startDate" class="border rounded px-3 py-2 text-sm w-full"></div>
        <div><label class="block text-xs font-bold text-gray-500 mb-1">结束日期</label><input type="date" id="endDate" class="border rounded px-3 py-2 text-sm w-full"></div>
        <div class="flex-1"><label class="block text-xs font-bold text-gray-500 mb-1">销售人员</label><select id="staffSelect" class="border rounded px-3 py-2 text-sm w-full bg-gray-50"><option value="">全部销售员</option></select></div>
        <button onclick="loadData()" class="bg-blue-600 text-white px-6 py-2 rounded font-bold text-sm hover:bg-blue-700">查询</button>
    </div>
</div>

<div class="grid grid-cols-3 gap-4 mb-6">
    <div class="bg-blue-50 p-4 rounded-xl border border-blue-100"><p class="text-xs text-blue-600 mb-1">总销售额</p><p class="text-2xl font-black text-blue-900" id="valSales">¥0</p></div>
    <div class="bg-gray-50 p-4 rounded-xl border border-gray-200"><p class="text-xs text-gray-500 mb-1">总成本</p><p class="text-2xl font-black text-gray-700" id="valCost">¥0</p></div>
    <div class="bg-yellow-50 p-4 rounded-xl border border-yellow-100"><p class="text-xs text-yellow-600 mb-1">净毛利</p><p class="text-2xl font-black text-yellow-900" id="valProfit">¥0</p></div>
</div>

<div class="bg-white rounded-xl shadow-sm overflow-hidden">
    <div class="px-6 py-4 border-b border-gray-100"><h3 class="font-bold text-gray-800">明细清单 (销售+租赁)</h3></div>
    <table class="w-full text-left text-sm"><tbody id="tbody" class="divide-y divide-gray-50"></tbody></table>
</div>

<script>
    const now = new Date();
    document.getElementById('startDate').value = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-01`;
    document.getElementById('endDate').value = now.toISOString().split('T')[0];
    let staffLoaded = false;

    async function loadData() {
        const start = document.getElementById('startDate').value;
        const end = document.getElementById('endDate').value;
        const staffId = document.getElementById('staffSelect').value;
        let url = `/api/analysis/profit_dashboard/?start_date=${start}&end_date=${end}&t=${Date.now()}`;
        if (staffId) url += `&staff_id=${staffId}`;

        try {
            const res = await axios.get(url);
            const data = res.data;
            document.getElementById('valSales').innerText = '¥' + parseFloat(data.summary.sales).toLocaleString();
            document.getElementById('valCost').innerText = '¥' + parseFloat(data.summary.cost).toLocaleString();
            document.getElementById('valProfit').innerText = '¥' + parseFloat(data.summary.profit).toLocaleString();

            if (!staffLoaded && data.options?.staff) {
                const sel = document.getElementById('staffSelect');
                data.options.staff.forEach(s => sel.innerHTML += `<option value="${s.id}">${s.name}</option>`);
                staffLoaded = true;
            }

            const tbody = document.getElementById('tbody');
            if (data.list.length === 0) { tbody.innerHTML = '<tr><td class="p-6 text-center text-gray-400">无数据</td></tr>'; return; }
            tbody.innerHTML = data.list.map(i => {
                const win = i.profit >= 0;
                return `<tr class="hover:bg-gray-50"><td class="px-6 py-4">
                    <div class="font-bold text-gray-800">${i.product_name}</div>
                    <div class="text-xs text-gray-400 mt-1">${i.date} <span class="bg-gray-100 px-1 rounded">${i.zencode}</span></div>
                </td><td class="px-6 py-4 text-right">
                    <div class="flex justify-end gap-2 mb-1"><span class="bg-blue-50 text-blue-600 px-2 py-0.5 rounded text-xs">销:${i.staff}</span><span class="bg-purple-50 text-purple-600 px-2 py-0.5 rounded text-xs">客:${i.customer}</span></div>
                    <div class="font-bold ${win?'text-green-600':'text-red-500'}">${win?'+':''}${parseFloat(i.profit).toLocaleString()}</div>
                </td></tr>`;
            }).join('');
        } catch (e) { alert('加载失败'); }
    }
    loadData();
</script>
{% endblock %}
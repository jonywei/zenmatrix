{% extends 'base.html' %}
{% block title %}å¿«é€Ÿå…¥åº“{% endblock %}
{% block content %}
<div class="max-w-4xl mx-auto bg-white rounded-2xl shadow-sm border border-gray-100 p-6 md:p-8">
    <div class="flex justify-between items-center mb-6 border-l-4 border-green-500 pl-3">
        <h2 class="text-xl font-bold text-gray-800">å•†å“å…¥åº“å­˜æ¡£</h2>
        <span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded">V1.3 å•†ä¸šå®Œæ•´ç‰ˆ</span>
    </div>
    
    <form id="entryForm" class="space-y-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <label class="block text-sm font-bold text-gray-700 mb-2">ä¾›åº”å•†</label>
                <div class="flex gap-2">
                    <select id="supplier_id" class="flex-1 h-10 border rounded px-3 bg-white outline-none focus:ring-2 focus:ring-green-500">
                        <option value="0">ğŸ›’ æ•£å®¢ / æ— ä¾›åº”å•†</option>
                    </select>
                    <button type="button" onclick="showAddModal()" class="w-10 h-10 bg-green-100 text-green-700 rounded font-bold hover:bg-green-200 text-xl flex items-center justify-center">+</button>
                </div>
            </div>
            <div>
                <label class="block text-sm font-bold text-gray-700 mb-2">å•†å“åˆ†ç±» <span class="text-red-500">*</span></label>
                <select id="category" class="w-full h-10 border rounded px-3 outline-none focus:ring-2 focus:ring-green-500" onchange="toggleFields()">
                    <option value="ZJ">ğŸ–¥ï¸ æ•´æœº (ç”µè„‘ä¸»æœº/ç¬”è®°æœ¬)</option>
                    <option value="XS">ğŸ“º æ˜¾ç¤ºå™¨</option>
                    <option value="SJ">ğŸ”Œ æ•£ä»¶/é…ä»¶</option>
                    <option value="ZX">ğŸ“¦ æ‚é¡¹/å…¶ä»–</option>
                </select>
            </div>
        </div>

        <div class="bg-gray-50 p-4 rounded-xl border border-dashed border-gray-300 text-center relative group hover:border-green-400 transition cursor-pointer">
            <input type="file" id="imageFile" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" onchange="previewImage(this)">
            <div id="uploadTip" class="py-6">
                <p class="text-4xl mb-2">ğŸ“·</p>
                <p class="text-sm text-gray-500 font-bold">ç‚¹å‡»æ‹æ‘„/ä¸Šä¼ å•†å“å›¾ç‰‡</p>
            </div>
            <img id="imgPreview" class="hidden h-40 mx-auto rounded shadow-sm object-contain bg-white relative z-0">
        </div>

        <div id="computerConfig" class="bg-blue-50 p-5 rounded-lg border border-blue-100 transition-all duration-300">
            <div class="flex justify-between items-center mb-4 pb-2 border-b border-blue-200">
                <h3 class="text-sm font-bold text-blue-700">ğŸ–¥ï¸ è¯¦ç»†é…ç½®å•</h3>
                <span class="text-xs text-blue-600 bg-white px-2 py-1 rounded shadow-sm border border-blue-100">è¾“å…¥é…ç½®+å¤‡æ³¨ â†’ è‡ªåŠ¨ç”Ÿæˆåç§°</span>
            </div>
            
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div>
                    <label class="text-xs text-blue-600 font-bold block mb-1">CPU</label>
                    <input id="cpu" class="w-full h-9 border rounded px-2 text-sm focus:ring-1 focus:ring-blue-500 outline-none" placeholder="i5-12400F" oninput="autoGenerateName()">
                </div>
                <div>
                    <label class="text-xs text-blue-600 font-bold block mb-1">å†…å­˜</label>
                    <input id="ram" class="w-full h-9 border rounded px-2 text-sm focus:ring-1 focus:ring-blue-500 outline-none" placeholder="16G" oninput="autoGenerateName()">
                </div>
                <div>
                    <label class="text-xs text-blue-600 font-bold block mb-1">ç¡¬ç›˜</label>
                    <input id="disk" class="w-full h-9 border rounded px-2 text-sm focus:ring-1 focus:ring-blue-500 outline-none" placeholder="512G" oninput="autoGenerateName()">
                </div>
                <div>
                    <label class="text-xs text-blue-600 font-bold block mb-1">æ˜¾å¡ (ç©º=æ ¸æ˜¾)</label>
                    <input id="gpu" class="w-full h-9 border rounded px-2 text-sm focus:ring-1 focus:ring-blue-500 outline-none" placeholder="RTX3060" oninput="autoGenerateName()">
                </div>
            </div>
        </div>

        <div>
            <label class="block text-sm font-bold text-gray-700 mb-2">é…ç½®å¤‡æ³¨ (æœºç®±/å¤–è§‚/æˆè‰²) <span class="text-xs text-gray-400 font-normal">ä¼šæ‹¼æ¥åˆ°åç§°ä¸­</span></label>
            <input id="note" class="w-full h-10 border rounded px-3" placeholder="ä¾‹å¦‚ï¼šæµ·æ™¯æˆ¿æœºç®± / 99æ–°" oninput="autoGenerateName()">
        </div>

        <div>
            <label class="block text-sm font-bold text-gray-700 mb-2">å•†å“åç§° (è‡ªåŠ¨ç”Ÿæˆ/æ‰‹åŠ¨ä¿®æ”¹) <span class="text-red-500">*</span></label>
            <input id="name" class="w-full h-10 border rounded px-3 focus:ring-2 focus:ring-green-500 font-bold text-gray-700 bg-gray-50" placeholder="å¡«å†™é…ç½®è‡ªåŠ¨ç”Ÿæˆ...">
        </div>

        <div class="bg-gray-50 p-5 rounded border border-gray-200 space-y-4">
            <div class="grid grid-cols-3 gap-4 border-b border-gray-200 pb-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">å…¥åº“æˆæœ¬ (åº•ä»·) <span class="text-red-500">*</span></label>
                    <input id="cost" type="number" class="w-full h-10 border rounded px-3 font-bold text-red-600 text-lg">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">åŒè¡Œä»· (æ‰¹å‘)</label>
                    <input id="peer_price" type="number" class="w-full h-10 border rounded px-3 font-bold text-blue-600" placeholder="0.00">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">é›¶å”®ä»· (æŒ‚ç‰Œ)</label>
                    <input id="retail_price" type="number" class="w-full h-10 border rounded px-3 font-bold text-green-600" placeholder="0.00">
                </div>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">æœ¬æ¬¡å®ä»˜é‡‘é¢</label>
                    <input id="paid" type="number" class="w-full h-10 border rounded px-3 font-bold text-gray-800" value="0">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">ä»˜æ¬¾è´¦æˆ·</label>
                    <select id="acc" class="w-full h-10 border rounded px-3 text-sm bg-white">
                        <option value="">é€‰æ‹©è´¦æˆ·(æœªä»˜ç•™ç©º)...</option>
                    </select>
                </div>
            </div>
        </div>

        <button type="button" onclick="submitForm()" class="w-full bg-green-600 text-white py-3 rounded-lg font-bold hover:bg-green-700 shadow-md text-lg transition transform active:scale-95">ç¡®è®¤å…¥åº“å­˜æ¡£</button>
    </form>
</div>

<div id="addModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
    <div class="bg-white p-6 rounded-lg w-80 shadow-xl">
        <h3 class="font-bold mb-4 text-gray-800">æ–°å¢ä¾›åº”å•†</h3>
        <input id="newCName" class="w-full border rounded h-10 px-3 mb-3" placeholder="åç§° (å¿…å¡«)">
        <input id="newCPhone" class="w-full border rounded h-10 px-3 mb-3" placeholder="ç”µè¯">
        <input id="newCAddr" class="w-full border rounded h-10 px-3 mb-4" placeholder="åœ°å€/æ¡£å£">
        <div class="flex justify-end gap-2">
            <button onclick="document.getElementById('addModal').classList.add('hidden')" class="px-4 py-2 bg-gray-100 rounded text-sm font-bold text-gray-600">å–æ¶ˆ</button>
            <button onclick="addContact()" class="px-4 py-2 bg-green-600 text-white rounded text-sm font-bold">ä¿å­˜</button>
        </div>
    </div>
</div>

<div id="successModal" class="fixed inset-0 bg-black bg-opacity-60 hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl w-full max-w-sm shadow-2xl overflow-hidden transform transition-all scale-100">
        <div class="bg-green-500 p-6 text-center">
            <div class="w-16 h-16 bg-white rounded-full flex items-center justify-center text-green-500 text-4xl font-black mx-auto mb-2">âœ“</div>
            <h3 class="text-white font-bold text-xl">å…¥åº“æˆåŠŸ!</h3>
        </div>
        <div class="p-6 text-center space-y-4">
            <div>
                <p class="text-xs text-gray-400 uppercase font-bold tracking-wider">ZenCode (å•†å“ç¼–ç )</p>
                <p class="text-3xl font-mono font-black text-gray-800 tracking-widest mt-1 select-all" id="resZencode">--</p>
            </div>
            <div>
                <p class="text-xs text-gray-400">å•†å“åç§°</p>
                <p class="text-sm font-bold text-gray-700 mt-1" id="resName">--</p>
            </div>
            <button onclick="location.reload()" class="w-full bg-green-100 text-green-700 py-3 rounded-xl font-bold hover:bg-green-200 transition">ç»§ç»­å…¥åº“</button>
        </div>
    </div>
</div>

<script>
    async function init() {
        const [c, a] = await Promise.all([axios.get('/api/contacts/?page_size=1000'), axios.get('/api/analysis/accounting/')]);
        const sSelect = document.getElementById('supplier_id');
        (c.data.results || c.data).forEach(i => sSelect.innerHTML += `<option value="${i.id}">${i.name}</option>`);
        a.data.accounts.forEach(i => document.getElementById('acc').innerHTML += `<option value="${i.id}">${i.name}</option>`);
    }
    init();

    // æ˜¾éšé€»è¾‘
    function toggleFields() {
        const cat = document.getElementById('category').value;
        const div = document.getElementById('computerConfig');
        if (cat === 'ZJ') {
            div.classList.remove('hidden');
        } else {
            div.classList.add('hidden');
            ['cpu','gpu','ram','disk'].forEach(id => document.getElementById(id).value = '');
        }
    }

    // å‘½åé€»è¾‘ (ä¿æŒæ‚¨è¦æ±‚çš„é¡ºåºï¼šCPU å†…å­˜ ç¡¬ç›˜ æ˜¾å¡ å¤‡æ³¨)
    function autoGenerateName() {
        const cat = document.getElementById('category').value;
        if (cat !== 'ZJ') return;

        const cpu = document.getElementById('cpu').value.trim();
        const ram = document.getElementById('ram').value.trim();
        const disk = document.getElementById('disk').value.trim();
        const gpuInput = document.getElementById('gpu').value.trim();
        const note = document.getElementById('note').value.trim();

        let parts = [];

        // 1. åŸºç¡€ä»¶é¡ºåºï¼šCPU -> å†…å­˜ -> ç¡¬ç›˜
        if(cpu) parts.push(cpu);
        if(ram) parts.push(ram);
        if(disk) parts.push(disk);

        // 2. æ˜¾å¡é€»è¾‘
        if (gpuInput) {
            parts.push(gpuInput); // æœ‰æ˜¾å¡ç›´æ¥åŠ 
            if(note) parts.push(note); // å¤‡æ³¨åœ¨æœ€å
        } else {
            // æ— æ˜¾å¡é€»è¾‘
            if(note) parts.push(note); // å¤‡æ³¨å‰ç½®
            if(cpu) parts.push("æ ¸æ˜¾ä¸»æœº"); // å¼ºè°ƒåç¼€
        }

        document.getElementById('name').value = parts.join(' + ');
    }

    function previewImage(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('imgPreview').src = e.target.result;
                document.getElementById('imgPreview').classList.remove('hidden');
                document.getElementById('uploadTip').classList.add('hidden');
            }
            reader.readAsDataURL(input.files[0]);
        }
    }

    window.showAddModal = () => document.getElementById('addModal').classList.remove('hidden');
    async function addContact() {
        const name = document.getElementById('newCName').value;
        if(!name) return alert('åç§°å¿…å¡«');
        try {
            const res = await axios.post('/api/contacts/', { 
                name, 
                phone: document.getElementById('newCPhone').value,
                address: document.getElementById('newCAddr').value
            });
            const sSelect = document.getElementById('supplier_id');
            const opt = document.createElement('option');
            opt.value = res.data.id; opt.text = res.data.name; opt.selected = true;
            sSelect.appendChild(opt);
            document.getElementById('addModal').classList.add('hidden');
        } catch(e) { alert('æ·»åŠ å¤±è´¥'); }
    }

    async function submitForm() {
        const cat = document.getElementById('category').value;
        const name = document.getElementById('name').value;
        const cost = document.getElementById('cost').value;
        
        if(!name || !cost) return alert("è¯·å¡«å†™å‹å·å’Œæˆæœ¬");

        let finalNote = document.getElementById('note').value;
        let gpuVal = document.getElementById('gpu').value;

        if (cat === 'ZJ') {
            if(!gpuVal) gpuVal = "æ ¸æ˜¾";
            const conf = [
                document.getElementById('cpu').value,
                gpuVal,
                document.getElementById('ram').value,
                document.getElementById('disk').value
            ].filter(Boolean).join(' / ');
            if (conf) finalNote = `[é…ç½®] ${conf} ${finalNote}`;
        }

        const formData = new FormData();
        formData.append('supplier_id', document.getElementById('supplier_id').value);
        formData.append('category', cat);
        formData.append('name', name);
        formData.append('cost_price', cost);
        formData.append('paid_amount', document.getElementById('paid').value || 0);
        formData.append('account_id', document.getElementById('acc').value || '');
        formData.append('note', finalNote);
        formData.append('peer_price', document.getElementById('peer_price').value || 0);
        formData.append('retail_price', document.getElementById('retail_price').value || 0);
        formData.append('cpu', document.getElementById('cpu').value);
        formData.append('gpu', gpuVal);
        formData.append('ram', document.getElementById('ram').value);
        formData.append('disk', document.getElementById('disk').value);

        const imgFile = document.getElementById('imageFile').files[0];
        if (imgFile) formData.append('image', imgFile);

        try {
            const res = await axios.post('/api/products/', formData, {
                headers: { 'Content-Type': 'multipart/form-data' }
            });
            document.getElementById('resZencode').innerText = res.data.zencode;
            document.getElementById('resName').innerText = res.data.name;
            document.getElementById('successModal').classList.remove('hidden');
        } catch(e) { alert("å…¥åº“å¤±è´¥: " + e); }
    }
</script>
{% endblock %}
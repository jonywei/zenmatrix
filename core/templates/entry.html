{% extends 'base.html' %}
{% block title %}å¿«é€Ÿå…¥åº“{% endblock %}
{% block content %}

<div class="max-w-4xl mx-auto" x-data="entryForm()">
    
    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 md:p-8">
        <div class="flex justify-between items-center mb-6 border-l-4 border-green-500 pl-3">
            <h2 class="text-xl font-bold text-gray-800">å•†å“å…¥åº“å­˜æ¡£ (æ‰¹é‡ç‰ˆ)</h2>
            <span class="text-xs text-gray-400" x-text="loading ? 'æ•°æ®åŠ è½½ä¸­...' : 'Ready'"></span>
        </div>

        <div class="space-y-6">
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="relative z-30">
                    <label class="block text-sm font-bold text-gray-700 mb-2">ä¾›åº”å•†</label>
                    <div class="flex gap-2 h-12">
                        <div class="relative w-full h-full" @click.away="closeSupplier()">
                            <input 
                                type="text" 
                                x-model="searchSupplier"
                                @focus="supOpen = true"
                                @input="supOpen = true"
                                placeholder="æœç´¢ä¾›åº”å•†å§“å/ç”µè¯..."
                                class="w-full h-full border border-gray-200 rounded-xl px-4 bg-gray-50 focus:bg-white focus:ring-2 focus:ring-green-500 outline-none transition"
                            >
                            <div x-show="supOpen" class="absolute left-0 right-0 mt-2 bg-white border border-gray-100 rounded-xl shadow-xl max-h-60 overflow-y-auto z-50" style="display: none;">
                                <div @click="selectSupplier({id: 0, name: 'ğŸ›’ æ•£å®¢ / æ— ä¾›åº”å•†'})" class="px-4 py-3 hover:bg-green-50 cursor-pointer border-b border-gray-50 font-bold text-green-700">
                                    ğŸ›’ æ•£å®¢ / æ— ä¾›åº”å•†
                                </div>
                                <template x-for="c in filteredSuppliers" :key="c.id">
                                    <div @click="selectSupplier(c)" class="px-4 py-3 hover:bg-blue-50 cursor-pointer border-b border-gray-50 last:border-0 group">
                                        <div class="flex justify-between items-center">
                                            <span class="font-bold text-gray-800" x-text="c.name"></span>
                                            <span class="text-xs text-gray-400" x-text="c.address || ''"></span>
                                        </div>
                                        <div class="text-xs text-gray-400" x-text="c.phone || 'æ— ç”µè¯'"></div>
                                    </div>
                                </template>
                            </div>
                        </div>
                        <button type="button" @click="showAddModal = true" class="w-12 h-full bg-green-100 text-green-700 rounded-xl font-bold hover:bg-green-200 transition text-xl flex-shrink-0 flex items-center justify-center">+</button>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">å•†å“åˆ†ç±» <span class="text-red-500">*</span></label>
                    <select x-model="form.category" class="w-full h-12 border border-gray-200 rounded-xl px-4 bg-white focus:ring-2 focus:ring-green-500 outline-none transition appearance-none">
                        <option value="ZJ">ğŸ–¥ï¸ æ•´æœº (ç”µè„‘ä¸»æœº/ç¬”è®°æœ¬)</option>
                        <option value="XS">ğŸ“º æ˜¾ç¤ºå™¨</option>
                        <option value="SJ">ğŸ”© æ•£ä»¶/é…ä»¶</option>
                        <option value="PH">ğŸ“± æ‰‹æœº (Phone)</option>
                        <option value="TB">ğŸ“Ÿ å¹³æ¿ (Tablet)</option>
                        <option value="ZX">ğŸ“¦ æ‚é¡¹/å…¶ä»–</option>
                    </select>
                </div>
            </div>

            <div class="bg-blue-50 p-4 rounded-xl border border-blue-200 grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-bold text-blue-800 mb-2">å…¥åº“æ•°é‡</label>
                    <input type="number" x-model="form.quantity" class="w-full h-12 border border-blue-300 rounded-lg px-4 font-bold text-lg text-blue-900 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="1">
                </div>
                <div class="flex items-center h-full pt-6">
                    <label class="flex items-center cursor-pointer">
                        <input type="checkbox" x-model="form.need_sn" class="form-checkbox h-6 w-6 text-blue-600 rounded focus:ring-blue-500 border-gray-300 transition duration-150 ease-in-out">
                        <span class="ml-2 text-sm font-bold text-gray-700">å¿…é¡»å½•å…¥åºåˆ—å·</span>
                    </label>
                </div>
                <div class="col-span-2 text-xs text-gray-500">
                    <span x-show="form.need_sn">âš ï¸ å°†ç”Ÿæˆâ€œå¾…å…¥åº“â€çŠ¶æ€ï¼Œéœ€åç»­æ‰«ç è½¬æ­£ã€‚</span>
                    <span x-show="!form.need_sn">âœ… å°†ç›´æ¥ç”Ÿæˆâ€œåœ¨åº“â€çŠ¶æ€ï¼Œç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆæµæ°´å·ã€‚</span>
                </div>
            </div>

            <div class="bg-gray-50 p-6 rounded-xl border-2 border-dashed border-gray-300 text-center relative group hover:border-green-400 transition cursor-pointer overflow-hidden h-48 flex flex-col justify-center items-center">
                <input type="file" x-ref="imageInput" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" @change="previewImage">
                <div x-show="!imgPreview" class="pointer-events-none">
                    <p class="text-4xl mb-2">ğŸ“·</p>
                    <p class="text-sm text-gray-500 font-bold">ç‚¹å‡»æ‹æ‘„/ä¸Šä¼ å•†å“å›¾ç‰‡</p>
                </div>
                <img x-show="imgPreview" :src="imgPreview" class="absolute inset-0 w-full h-full object-contain bg-white z-0 p-2">
            </div>

            <div class="bg-yellow-50 p-4 rounded-xl border border-yellow-200">
                <label class="block text-sm font-bold text-yellow-800 mb-2">
                    ğŸ”¢ åºåˆ—å· / IMEI / SNç  <span x-text="form.need_sn ? '(å¿…å¡«)' : '(é€‰å¡«)'" class="text-xs font-normal text-gray-500"></span>
                </label>
                <input type="text" x-model="form.sn" class="w-full h-12 border border-yellow-300 rounded-lg px-4 text-lg font-mono tracking-wide focus:ring-2 focus:ring-yellow-500 outline-none bg-white" :placeholder="snPlaceholder">
            </div>

            <div x-show="showConfig" x-transition class="bg-blue-50 p-5 rounded-xl border border-blue-100 transition-all duration-300">
                <div class="flex justify-between items-center mb-4 pb-2 border-b border-blue-200">
                    <h3 class="text-sm font-bold text-blue-700" x-text="configTitle">ğŸ–¥ï¸ è¯¦ç»†é…ç½®å•</h3>
                    <button type="button" @click="generateName()" class="text-xs text-blue-600 bg-white px-2 py-1 rounded shadow-sm border border-blue-100 hover:bg-blue-50">åˆ·æ–°åç§° â†»</button>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div><label class="text-xs text-blue-600 font-bold block mb-1" x-text="labels.l1">CPU</label><input x-model="form.cpu" @input="generateName" class="w-full h-10 border rounded-lg px-2 text-sm focus:ring-1 focus:ring-blue-500 outline-none" :placeholder="placeholders.p1"></div>
                    <div><label class="text-xs text-blue-600 font-bold block mb-1" x-text="labels.l2">å†…å­˜</label><input x-model="form.ram" @input="generateName" class="w-full h-10 border rounded-lg px-2 text-sm focus:ring-1 focus:ring-blue-500 outline-none" :placeholder="placeholders.p2"></div>
                    <div><label class="text-xs text-blue-600 font-bold block mb-1" x-text="labels.l3">ç¡¬ç›˜</label><input x-model="form.disk" @input="generateName" class="w-full h-10 border rounded-lg px-2 text-sm focus:ring-1 focus:ring-blue-500 outline-none" :placeholder="placeholders.p3"></div>
                    <div><label class="text-xs text-blue-600 font-bold block mb-1" x-text="labels.l4">æ˜¾å¡</label><input x-model="form.gpu" @input="generateName" class="w-full h-10 border rounded-lg px-2 text-sm focus:ring-1 focus:ring-blue-500 outline-none" :placeholder="placeholders.p4"></div>
                </div>
            </div>

            <div>
                <label class="block text-sm font-bold text-gray-700 mb-2">å¤‡æ³¨ / æˆè‰²</label>
                <input x-model="form.note" @input="generateName" class="w-full h-12 border border-gray-200 rounded-xl px-4 focus:ring-2 focus:ring-green-500 outline-none" :placeholder="notePlaceholder">
            </div>

            <div>
                <label class="block text-sm font-bold text-gray-700 mb-2">å•†å“åç§° <span class="text-red-500">*</span></label>
                <input x-model="form.name" class="w-full h-12 border border-gray-200 rounded-xl px-4 focus:ring-2 focus:ring-green-500 font-bold text-gray-700 bg-gray-50 outline-none" placeholder="å¡«å†™é…ç½®è‡ªåŠ¨ç”Ÿæˆ...">
            </div>

            <div class="bg-gray-50 p-6 rounded-xl border border-gray-200 space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 border-b border-gray-200 pb-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">å•ä»¶æˆæœ¬ <span class="text-red-500">*</span></label>
                        <div class="relative"><span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">Â¥</span><input x-model="form.cost_price" type="number" class="w-full h-12 border rounded-xl pl-8 pr-4 font-bold text-red-600 text-lg outline-none focus:border-red-500"></div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">åŒè¡Œä»·</label>
                        <div class="relative"><span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">Â¥</span><input x-model="form.peer_price" type="number" class="w-full h-12 border rounded-xl pl-8 pr-4 font-bold text-blue-600 outline-none focus:border-blue-500"></div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">é›¶å”®ä»·</label>
                        <div class="relative"><span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">Â¥</span><input x-model="form.retail_price" type="number" class="w-full h-12 border rounded-xl pl-8 pr-4 font-bold text-green-600 outline-none focus:border-green-500"></div>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">å®ä»˜æ€»é¢</label>
                        <div class="relative"><span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">Â¥</span><input x-model="form.paid_amount" type="number" class="w-full h-12 border rounded-xl pl-8 pr-4 font-bold text-gray-800 outline-none"></div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">ä»˜æ¬¾è´¦æˆ·</label>
                        <select x-model="form.account_id" class="w-full h-12 border rounded-xl px-4 text-sm bg-white outline-none">
                            <option value="">æš‚ä¸ä»˜æ¬¾...</option>
                            <template x-for="acc in accounts" :key="acc.id">
                                <option :value="acc.id" x-text="acc.name"></option>
                            </template>
                        </select>
                    </div>
                </div>
                <div class="text-xs text-red-500 font-bold" x-show="(form.cost_price * form.quantity) > form.paid_amount">
                    âš ï¸ æ¬ æ¬¾: Â¥<span x-text="((form.cost_price * form.quantity) - form.paid_amount).toFixed(2)"></span> å°†è®¡å…¥åº”ä»˜è´¦æ¬¾
                </div>
            </div>

            <button type="button" @click="submit()" :disabled="submitting" class="w-full bg-green-600 text-white py-4 rounded-xl font-bold hover:bg-green-700 shadow-lg hover:shadow-xl transition transform active:scale-[0.99] disabled:opacity-50 text-lg">
                <span x-show="!submitting" x-text="form.quantity > 1 ? `æ‰¹é‡å…¥åº“ (${form.quantity}ä»¶)` : 'ç¡®è®¤å…¥åº“å­˜æ¡£'"></span>
                <span x-show="submitting">æ­£åœ¨æäº¤...</span>
            </button>
        </div>
    </div>

    <div x-show="showAddModal" class="fixed inset-0 bg-black bg-opacity-40 z-50 flex items-center justify-center backdrop-blur-sm" style="display: none;" x-transition.opacity><div class="bg-white p-8 rounded-2xl w-full max-w-md shadow-2xl" @click.away="showAddModal = false"><h3 class="font-black text-xl text-gray-800 mb-6">æ–°å¢ä¾›åº”å•†</h3><div class="space-y-4"><input x-model="newContact.name" class="w-full border border-gray-200 rounded-xl h-12 px-4 focus:ring-2 focus:ring-green-500 outline-none" placeholder="åç§° (å¿…å¡«)"><input x-model="newContact.phone" class="w-full border border-gray-200 rounded-xl h-12 px-4 focus:ring-2 focus:ring-green-500 outline-none" placeholder="ç”µè¯ (é€‰å¡«)"><input x-model="newContact.address" class="w-full border border-gray-200 rounded-xl h-12 px-4 focus:ring-2 focus:ring-green-500 outline-none" placeholder="åœ°å€/æ¡£å£ (é€‰å¡«)"></div><div class="flex justify-end gap-3 mt-8"><button @click="showAddModal = false" class="px-5 py-2.5 bg-gray-100 rounded-xl text-sm font-bold text-gray-600">å–æ¶ˆ</button><button @click="saveNewContact()" class="px-6 py-2.5 bg-green-600 text-white rounded-xl text-sm font-bold hover:bg-green-700">ä¿å­˜</button></div></div></div>
    <div x-show="showSuccess" class="fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4" style="display: none;" x-transition.opacity><div class="bg-white rounded-2xl w-full max-w-sm shadow-2xl overflow-hidden transform transition-all" x-transition.scale><div class="bg-green-500 p-6 text-center"><h3 class="text-white font-bold text-xl">âœ… å…¥åº“æˆåŠŸ!</h3></div><div class="p-6 text-center space-y-4"><div><p class="text-xs text-gray-400">ZenCode</p><p class="text-3xl font-mono font-black text-gray-800" x-text="resZencode">--</p></div><div><p class="text-xs text-gray-400">å•†å“åç§°</p><p class="text-sm font-bold text-gray-700 mt-1" x-text="resName">--</p></div><button @click="window.location.reload()" class="w-full bg-green-100 text-green-700 py-3 rounded-xl font-bold hover:bg-green-200 transition">ç»§ç»­å…¥åº“</button></div></div></div>

</div>

<script>
    function entryForm() {
        return {
            loading: true, submitting: false, contacts: [], accounts: [], supOpen: false, searchSupplier: '', showAddModal: false, showSuccess: false, resZencode: '', resName: '', newContact: { name: '', phone: '', address: '' }, imgPreview: null,
            form: {
                supplier_id: 0, category: 'ZJ', sn: '', name: '', note: '', cpu: '', gpu: '', ram: '', disk: '', cost_price: '', peer_price: '', retail_price: '', paid_amount: 0, account_id: '',
                // ğŸŸ¢ æ–°å¢
                quantity: 1,
                need_sn: false
            },
            async init() {
                try {
                    const [cRes, aRes] = await Promise.all([ axios.get('/api/contacts/?page_size=1000'), axios.get('/api/analysis/accounting/') ]);
                    this.contacts = cRes.data.results || cRes.data; this.accounts = aRes.data.accounts || [];
                    if (this.accounts.length > 0) this.form.account_id = this.accounts[0].id;
                } catch(e) { console.error(e); } finally { this.loading = false; }
                this.$watch('form.category', () => this.generateName());
            },
            get filteredSuppliers() { if(!this.searchSupplier) return this.contacts.slice(0, 5); const k = this.searchSupplier.toLowerCase(); return this.contacts.filter(c => c.name.toLowerCase().includes(k) || (c.phone && c.phone.includes(k))); },
            selectSupplier(c) { this.form.supplier_id = c.id; this.searchSupplier = c.name; this.supOpen = false; },
            closeSupplier() { setTimeout(() => this.supOpen = false, 200) },
            async saveNewContact() { if(!this.newContact.name) return alert("åç§°å¿…å¡«"); try { const res = await axios.post('/api/contacts/', this.newContact); this.contacts.unshift(res.data); this.selectSupplier(res.data); this.showAddModal = false; this.newContact = { name: '', phone: '', address: '' }; } catch(e) { const detail = e.response?.data ? JSON.stringify(e.response.data) : "ç½‘ç»œé”™è¯¯"; alert("æ·»åŠ å¤±è´¥: " + detail); } },
            previewImage(e) { const file = e.target.files[0]; if(file) { const reader = new FileReader(); reader.onload = (e) => this.imgPreview = e.target.result; reader.readAsDataURL(file); } },
            get showConfig() { return !['SJ', 'ZX'].includes(this.form.category); },
            get labels() { const c = this.form.category; if(['PH', 'TB'].includes(c)) return { l1: 'å“ç‰Œ', l2: 'å‹å·', l3: 'å®¹é‡', l4: 'é¢œè‰²/ç‰ˆæœ¬' }; if(c === 'XS') return { l1: 'å“ç‰Œ', l2: 'å°ºå¯¸', l3: 'åˆ·æ–°ç‡', l4: 'é¢æ¿/åˆ†è¾¨ç‡' }; return { l1: 'CPU', l2: 'å†…å­˜', l3: 'ç¡¬ç›˜', l4: 'æ˜¾å¡ (ç©º=æ ¸æ˜¾)' }; },
            get placeholders() { const c = this.form.category; if(['PH', 'TB'].includes(c)) return { p1: 'Apple/åä¸º', p2: 'iPhone 15', p3: '256G', p4: 'é»‘è‰²/å›½è¡Œ' }; if(c === 'XS') return { p1: 'ä¸‰æ˜Ÿ/AOC', p2: '27è‹±å¯¸', p3: '144Hz', p4: 'IPS/4K' }; return { p1: 'i5-12400F', p2: '16G', p3: '512G', p4: 'RTX3060' }; },
            get configTitle() { const c = this.form.category; if(c === 'PH') return 'ğŸ“± æ‰‹æœºå‚æ•°'; if(c === 'TB') return 'ğŸ“Ÿ å¹³æ¿å‚æ•°'; if(c === 'XS') return 'ğŸ“º æ˜¾ç¤ºå™¨å‚æ•°'; return 'ğŸ–¥ï¸ è¯¦ç»†é…ç½®å•'; },
            get notePlaceholder() { if(['PH', 'TB'].includes(this.form.category)) return "ä¾‹å¦‚ï¼šç”µæ± 98% / å±å¹•æ— åˆ’ç—• / åœ¨ä¿"; return "ä¾‹å¦‚ï¼šæµ·æ™¯æˆ¿æœºç®± / 99æ–°"; },
            
            // ğŸŸ¢ åŠ¨æ€ Placeholder
            get snPlaceholder() {
                if(this.form.need_sn) return "ğŸ“± å¿…é¡»æ‰«æ/è¾“å…¥ IMEI";
                return "é€‰å¡«ï¼Œç•™ç©ºè‡ªåŠ¨ç”Ÿæˆæµæ°´å·";
            },

            generateName() { const c = this.form.category; if (['SJ', 'ZX'].includes(c)) return; const { cpu, ram, disk, gpu, note } = this.form; const parts = []; if (['PH', 'TB', 'XS'].includes(c)) { if(cpu) parts.push(cpu); if(ram) parts.push(ram); if(disk) parts.push(disk); if(gpu) parts.push(gpu); } else { if(cpu) parts.push(cpu); if(ram) parts.push(ram); if(disk) parts.push(disk); if(gpu) parts.push(gpu); else if(cpu) parts.push("æ ¸æ˜¾ä¸»æœº"); } if(note) parts.push(note); this.form.name = parts.join(' '); },
            
            async submit() {
                if(!this.form.name || !this.form.cost_price) return alert("åç§°å’Œæˆæœ¬å¿…å¡«");
                // ğŸŸ¢ æ ¡éªŒï¼šå¦‚æœå¿…é¡»åºåˆ—å·ä¸”åªæœ‰1ä¸ªï¼Œå¼ºåˆ¶å¡«SN
                if(this.form.quantity == 1 && this.form.need_sn && !this.form.sn) return alert("ğŸ“± å¿…é¡»å¡«å†™ IMEI/åºåˆ—å·ï¼");

                this.submitting = true;
                const fd = new FormData();
                fd.append('supplier_id', this.form.supplier_id); fd.append('category', this.form.category); fd.append('name', this.form.name); fd.append('sn', this.form.sn);
                fd.append('cost_price', this.form.cost_price); fd.append('note', this.form.note); fd.append('cpu', this.form.cpu); fd.append('gpu', this.form.gpu); fd.append('ram', this.form.ram); fd.append('disk', this.form.disk);
                fd.append('peer_price', this.form.peer_price || 0); fd.append('retail_price', this.form.retail_price || 0); fd.append('paid_amount', this.form.paid_amount || 0); fd.append('account_id', this.form.account_id || '');
                // ğŸŸ¢ ä¼ æ–°å‚æ•°
                fd.append('quantity', this.form.quantity);
                fd.append('need_sn', this.form.need_sn);
                
                const file = this.$refs.imageInput.files[0];
                if(file) fd.append('image', file);

                try {
                    const res = await axios.post('/api/products/', fd, { headers: { 'Content-Type': 'multipart/form-data' } });
                    this.resZencode = res.data.zencode; this.resName = res.data.name; this.showSuccess = true;
                } catch(e) { const detail = e.response?.data ? JSON.stringify(e.response.data) : e.message; alert("å…¥åº“å¤±è´¥: " + detail); } finally { this.submitting = false; }
            }
        }
    }
</script>
{% endblock %}
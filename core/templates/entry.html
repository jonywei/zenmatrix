<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æé€Ÿå…¥åº“</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.staticfile.net/vue/3.3.4/vue.global.min.js"></script>
    <script src="https://cdn.staticfile.net/axios/1.6.0/axios.min.js"></script>
    <style>
        body { background-color: #f3f4f6; color: #1f2937; min-height: 100vh; padding-bottom: 40px; font-family: sans-serif; }
        .input-light { background: white; border: 1px solid #e5e7eb; color: #1f2937; transition: all 0.2s; }
        .input-light:focus { border-color: #3b82f6; ring: 2px solid #3b82f6; outline: none; }
        .modal-mask { position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.5); z-index: 100; display: flex; align-items: center; justify-content: center; }
        [v-cloak] { display: none; }
    </style>
</head>
<body class="p-4 max-w-md mx-auto">
    <div id="app" v-cloak>
        
        <div class="flex items-center justify-between mb-6">
            <a href="/" class="w-10 h-10 bg-white rounded-full shadow flex items-center justify-center text-gray-600 active:bg-gray-100">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
            </a>
            <h1 class="text-lg font-bold text-gray-800">å…¥åº“é‡‡è´­</h1>
            <div class="w-10"></div>
        </div>

        <div v-if="successMsg" class="mb-4 bg-green-50 border border-green-200 text-green-700 p-4 rounded-xl text-center shadow-sm">
            <div class="font-bold">å…¥åº“æˆåŠŸ</div>
            <div class="font-mono text-sm mt-1">[[ successMsg ]]</div>
        </div>

        <div class="bg-white rounded-2xl shadow-sm p-5 space-y-5">
            
            <div class="bg-blue-50 p-3 rounded-xl border border-blue-100">
                <label class="block text-xs font-bold text-blue-600 mb-2 uppercase">é€‰æ‹©ä¾›åº”å•† (å¿…å¡«)</label>
                <div class="flex gap-2">
                    <select v-model="form.supplier_id" class="flex-1 p-3 rounded-lg bg-white border border-blue-200 text-sm outline-none">
                        <option value="" disabled>è¯·é€‰æ‹©...</option>
                        <option value="0">ğŸ›’ æ•£å®¢ (æ— ä¾›åº”å•†)</option>
                        <option v-for="c in contacts" :value="c.id">[[ c.name ]]</option>
                    </select>
                    <button @click="showAddModal=true" class="bg-blue-600 text-white px-4 rounded-lg font-bold text-xl shadow active:bg-blue-700">+</button>
                </div>
            </div>

            <div>
                <label class="block text-xs font-bold text-gray-500 mb-2">å•†å“åˆ†ç±»</label>
                <div class="grid grid-cols-4 gap-2">
                    <button v-for="t in types" :key="t.key" @click="form.category = t.key" :class="form.category === t.key ? 'bg-blue-600 text-white shadow-md' : 'bg-gray-100 text-gray-500'" class="p-3 rounded-xl text-sm font-bold transition-all">[[ t.name ]]</button>
                </div>
            </div>

            <div class="relative w-full h-40 bg-gray-50 rounded-xl border-2 border-dashed border-gray-300 flex flex-col items-center justify-center overflow-hidden active:bg-gray-100" @click="$refs.fileInput.click()">
                <img v-if="previewUrl" :src="previewUrl" class="absolute w-full h-full object-cover">
                <div v-else class="text-center text-gray-400">
                    <span class="text-3xl block mb-1">ğŸ“·</span>
                    <span class="text-xs">ç‚¹å‡»æ‹æ‘„é…ç½®å›¾</span>
                </div>
                <input type="file" ref="fileInput" @change="handleFileUpload" accept="image/*" class="hidden">
            </div>

            <div v-if="form.category === 'ZJ'" class="space-y-3">
                <div class="grid grid-cols-2 gap-3">
                    <input v-model="form.cpu" placeholder="CPU" class="w-full p-3 rounded-lg input-light text-sm">
                    <input v-model="form.gpu" placeholder="æ˜¾å¡" class="w-full p-3 rounded-lg input-light text-sm">
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <input v-model="form.ram" placeholder="å†…å­˜" class="w-full p-3 rounded-lg input-light text-sm">
                    <input v-model="form.disk" placeholder="ç¡¬ç›˜" class="w-full p-3 rounded-lg input-light text-sm">
                </div>
                <input v-model="form.note" placeholder="å¤‡æ³¨" class="w-full p-3 rounded-lg input-light text-sm">
            </div>
            <div v-else>
                <input v-model="form.name" placeholder="è¾“å…¥å‹å·..." class="w-full p-3 rounded-lg input-light">
            </div>

            <div class="bg-gray-50 p-4 rounded-xl border border-gray-100">
                <div class="mb-2">
                    <label class="block text-xs font-bold text-gray-500 mb-1">å…¥åº“æˆæœ¬ (åº”ä»˜)</label>
                    <div class="relative">
                        <span class="absolute left-3 top-3 text-gray-400">Â¥</span>
                        <input :type="showCost ? 'number' : 'password'" v-model="form.cost_price" placeholder="0.00" class="w-full p-3 pl-8 rounded-lg bg-white border border-blue-200 text-xl font-bold text-gray-800">
                        <button @click="showCost = !showCost" class="absolute right-3 top-3 text-gray-400">[[ showCost ? 'ğŸ™ˆ' : 'ğŸ‘ï¸' ]]</button>
                    </div>
                </div>

                <div class="bg-white p-3 rounded-lg border border-gray-200 mb-4">
                    <div class="relative mb-2">
                        <span class="absolute left-3 top-2 text-gray-500 text-sm">å®ä»˜</span>
                        <input type="number" v-model="form.paid_amount" class="w-full p-2 pl-12 rounded border border-gray-200 text-sm font-bold text-blue-600 focus:border-blue-500 outline-none">
                    </div>
                    
                    <div class="text-xs mb-2 pl-1">
                        <span v-if="debtAmount > 0" class="text-red-500 font-bold">âš ï¸ å‰©ä½™ Â¥[[ debtAmount ]] è®¡å…¥åº”ä»˜è´¦æ¬¾</span>
                        <span v-else-if="form.paid_amount == 0" class="text-red-500 font-bold">âš ï¸ å…¨é¢æŒ‚è´¦ (æ¬ æ¬¾)</span>
                        <span v-else class="text-blue-600 font-bold">âœ… å…¨é¢å·²ä»˜</span>
                    </div>

                    <div v-if="form.paid_amount > 0" class="animate-fade-in">
                        <select v-model="form.account_id" class="w-full p-2 rounded border border-gray-200 text-sm bg-white">
                            <option value="" disabled>æ”¯ä»˜è´¦æˆ· (å¿…é€‰)</option>
                            <option v-for="acc in accounts" :value="acc.id">[[ acc.name ]]</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3 pt-2 border-t border-gray-200">
                    <input type="number" v-model="form.peer_price" placeholder="åŒè¡Œåº•ä»·" class="w-full p-2 rounded input-light text-sm">
                    <input type="number" v-model="form.retail_price" placeholder="é›¶å”®æŒ‡å¯¼" class="w-full p-2 rounded input-light text-sm">
                </div>
            </div>

            <button @click="submit" :disabled="loading" class="w-full bg-blue-600 text-white font-bold py-4 rounded-xl shadow-lg shadow-blue-200 active:scale-95 transition-transform">
                [[ loading ? 'æäº¤ä¸­...' : 'ç¡®è®¤å…¥åº“' ]]
            </button>
        </div>

        <div v-if="showAddModal" class="modal-mask">
            <div class="bg-white p-6 rounded-2xl w-80 shadow-2xl animate-bounce-in">
                <h3 class="font-bold text-lg mb-4 text-gray-800">æ–°å»ºä¾›åº”å•†</h3>
                <div class="space-y-3">
                    <input v-model="newContact.name" placeholder="å§“å (å¿…å¡«)" class="w-full p-3 rounded-lg border border-gray-300 focus:border-blue-500 outline-none">
                    <input v-model="newContact.phone" placeholder="ç”µè¯ (é€‰å¡«)" class="w-full p-3 rounded-lg border border-gray-300 focus:border-blue-500 outline-none">
                    <input v-model="newContact.address" placeholder="åœ°å€/æ¡£å£ (é€‰å¡«)" class="w-full p-3 rounded-lg border border-gray-300 focus:border-blue-500 outline-none">
                </div>
                <div class="flex gap-2 mt-5">
                    <button @click="showAddModal=false" class="flex-1 py-3 rounded-lg bg-gray-100 text-gray-600 font-bold">å–æ¶ˆ</button>
                    <button @click="addContact" class="flex-1 py-3 rounded-lg bg-blue-600 text-white font-bold">ä¿å­˜</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        const { createApp } = Vue
        axios.defaults.headers.common['X-CSRFToken'] = '{{ csrf_token }}';

        const app = createApp({
            data() {
                return {
                    types: [{key: 'ZJ', name: 'æ•´æœº'}, {key: 'SJ', name: 'æ•£ä»¶'}, {key: 'XS', name: 'æ˜¾ç¤ºå™¨'}, {key: 'ZX', name: 'æ‚é¡¹'}],
                    form: { 
                        category: 'ZJ', supplier_id: '', name: '', 
                        cpu: '', gpu: '', ram: '', disk: '', note: '', 
                        cost_price: '', paid_amount: '', account_id: '',
                        peer_price: '', retail_price: '', image: null 
                    },
                    contacts: [], accounts: [],
                    previewUrl: null, showCost: false, loading: false, successMsg: '',
                    showAddModal: false, newContact: { name: '', phone: '', address: '' }
                }
            },
            computed: {
                debtAmount() {
                    const cost = parseFloat(this.form.cost_price || 0);
                    const paid = parseFloat(this.form.paid_amount || 0);
                    return (cost - paid).toFixed(2);
                }
            },
            watch: {
                // é»˜è®¤å®ä»˜=æˆæœ¬ (æ‡’äººä¼˜åŒ–)
                'form.cost_price'(val) {
                    if(!this.form.paid_amount) this.form.paid_amount = val;
                }
            },
            mounted() { this.loadData(); },
            methods: {
                async loadData() {
                    try { 
                        const [cRes, aRes] = await Promise.all([
                            axios.get('/api/contacts/'),
                            axios.get('/api/analysis/accounting/')
                        ]);
                        this.contacts = cRes.data.results || cRes.data;
                        this.accounts = aRes.data.accounts || []; 
                        // é»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ªè´¦æˆ·
                        if(this.accounts.length > 0) this.form.account_id = this.accounts[0].id;
                    } catch(e){}
                },
                async addContact() {
                    if(!this.newContact.name) return alert('å§“åå¿…å¡«');
                    try {
                        const res = await axios.post('/api/contacts/', this.newContact);
                        await this.loadData();
                        this.form.supplier_id = res.data.id;
                        this.showAddModal = false;
                        this.newContact = { name: '', phone: '', address: '' };
                    } catch(e) { alert('æ–°å»ºå¤±è´¥'); }
                },
                handleFileUpload(event) {
                    const file = event.target.files[0];
                    if (file) { this.form.image = file; this.previewUrl = URL.createObjectURL(file); }
                },
                async submit() {
                    if (this.form.supplier_id === '') return alert('âš ï¸ å¿…é¡»é€‰æ‹©ä¾›åº”å•†');
                    if (!this.form.cost_price) return alert('âš ï¸ è¯·å¡«å†™å…¥åº“æˆæœ¬');
                    
                    const paid = parseFloat(this.form.paid_amount || 0);
                    if(paid > 0 && !this.form.account_id) return alert('âš ï¸ æ—¢ç„¶å®ä»˜äº†ï¼Œè¯·é€‰æ‹©ä»å“ªä¸ªè´¦æˆ·ä»˜çš„');

                    this.loading = true;
                    const formData = new FormData();
                    if (this.form.category !== 'ZJ' && !this.form.name) { this.loading = false; return alert('è¯·å¡«å†™åç§°'); }
                    
                    for (let key in this.form) if (this.form[key] || this.form[key]===0) formData.append(key, this.form[key]);
                    
                    try {
                        const res = await axios.post('/api/products/', formData, { headers: { 'Content-Type': 'multipart/form-data' }});
                        this.successMsg = `ç¼–ç : ${res.data.zencode}`;
                        this.resetForm();
                        setTimeout(() => this.successMsg = '', 3000);
                    } catch (e) { alert('å¤±è´¥: ' + (e.response?.data?.detail || e.message)); }
                    finally { this.loading = false; }
                },
                resetForm() {
                    const cat = this.form.category;
                    const sup = this.form.supplier_id; 
                    const acc = this.form.account_id;
                    this.form = { 
                        category: cat, supplier_id: sup, name: '', 
                        cpu: '', gpu: '', ram: '', disk: '', note: '', 
                        cost_price: '', paid_amount: '', account_id: acc,
                        peer_price: '', retail_price: '', image: null 
                    };
                    this.previewUrl = null; this.$refs.fileInput.value = '';
                }
            },
            compilerOptions: { delimiters: ['[[', ']]'] }
        }).mount('#app');
    </script>
</body>
</html>
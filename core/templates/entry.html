<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æé€Ÿå…¥åº“</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.staticfile.net/vue/3.3.4/vue.global.min.js"></script>
    <script src="https://cdn.staticfile.net/axios/1.6.0/axios.min.js"></script>
    <link rel="stylesheet" href="https://cdn.staticfile.net/element-plus/2.3.8/index.min.css" />
    <script src="https://cdn.staticfile.net/element-plus/2.3.8/index.full.min.js"></script>
    
    <style>
        [v-cloak] { display: none; }
        body { background-color: #f3f4f6; font-family: -apple-system, sans-serif; padding-bottom: 50px; }
        /* ä¿®å¤iOSè¾“å…¥æ¡†åœ†è§’é—®é¢˜ */
        input { -webkit-appearance: none; border-radius: 0.5rem; }
    </style>
</head>
<body class="p-4 max-w-md mx-auto">
    <div id="app" v-cloak>
        
        <div class="flex items-center justify-between mb-6">
            <a href="/" class="w-10 h-10 bg-white rounded-full shadow flex items-center justify-center text-gray-600 active:bg-gray-100">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
            </a>
            <h1 class="text-lg font-bold text-gray-800">å…¥åº“é‡‡è´­</h1>
            <div class="w-10"></div>
        </div>

        <div class="bg-white rounded-2xl shadow-sm p-5 space-y-5">
            
            <div class="bg-blue-50 p-3 rounded-xl border border-blue-100">
                <label class="block text-xs font-bold text-blue-600 mb-2 uppercase">é€‰æ‹©ä¾›åº”å•† (å¿…å¡«)</label>
                <div class="flex gap-2">
                    <select v-model="form.supplier_id" class="flex-1 p-3 rounded-lg bg-white border border-blue-200 text-sm outline-none">
                        <option value="" disabled>è¯·é€‰æ‹©...</option>
                        <option value="0">ğŸ›’ æ•£å®¢ (æ— ä¾›åº”å•†)</option>
                        <option v-for="c in contacts" :value="c.id">[[ c.name ]]</option>
                    </select>
                    <button @click="showAddModal=true" class="bg-blue-600 text-white px-4 rounded-lg font-bold text-xl shadow active:bg-blue-700">+</button>
                </div>
            </div>

            <div>
                <label class="block text-xs font-bold text-gray-500 mb-2">å•†å“åˆ†ç±»</label>
                <div class="grid grid-cols-4 gap-2">
                    <button v-for="t in types" :key="t.key" @click="form.category = t.key" :class="form.category === t.key ? 'bg-blue-600 text-white shadow-md' : 'bg-gray-100 text-gray-500'" class="p-3 rounded-xl text-sm font-bold transition-all">[[ t.name ]]</button>
                </div>
            </div>

            <div class="relative w-full h-40 bg-gray-50 rounded-xl border-2 border-dashed border-gray-300 flex flex-col items-center justify-center overflow-hidden active:bg-gray-100" @click="$refs.fileInput.click()">
                <img v-if="previewUrl" :src="previewUrl" class="absolute w-full h-full object-cover">
                <div v-else class="text-center text-gray-400">
                    <span class="text-3xl block mb-1">ğŸ“·</span>
                    <span class="text-xs">ç‚¹å‡»æ‹æ‘„é…ç½®å›¾</span>
                </div>
                <input type="file" ref="fileInput" @change="handleFileUpload" accept="image/*" class="hidden">
            </div>

            <div v-if="form.category === 'ZJ'" class="space-y-3">
                <div class="grid grid-cols-2 gap-3">
                    <input v-model="form.cpu" placeholder="CPU" class="w-full p-3 bg-white border border-gray-200 text-sm">
                    <input v-model="form.gpu" placeholder="æ˜¾å¡" class="w-full p-3 bg-white border border-gray-200 text-sm">
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <input v-model="form.ram" placeholder="å†…å­˜" class="w-full p-3 bg-white border border-gray-200 text-sm">
                    <input v-model="form.disk" placeholder="ç¡¬ç›˜" class="w-full p-3 bg-white border border-gray-200 text-sm">
                </div>
                <input v-model="form.note" type="text" placeholder="å¤‡æ³¨ (å¦‚ ç™½è‰²æµ·æ™¯æˆ¿)" class="w-full p-3 bg-white border border-gray-200 text-sm">
            </div>
            <div v-else>
                <input v-model="form.name" placeholder="è¾“å…¥å‹å·..." class="w-full p-3 bg-white border border-gray-200">
            </div>

            <div class="bg-gray-50 p-4 rounded-xl border border-gray-100">
                <div class="mb-4">
                    <label class="block text-xs font-bold text-gray-500 mb-1">å…¥åº“æˆæœ¬ (åº”ä»˜)</label>
                    <div class="relative">
                        <span class="absolute left-3 top-3 text-gray-400">Â¥</span>
                        <input type="number" v-model="form.cost_price" placeholder="0.00" class="w-full p-3 pl-8 rounded-lg bg-white border border-blue-200 text-xl font-bold text-gray-800">
                    </div>
                </div>

                <div class="bg-white p-3 rounded-lg border border-gray-200 mb-4">
                    <div class="relative mb-2">
                        <span class="absolute left-3 top-2 text-gray-500 text-sm">å®ä»˜</span>
                        <input type="number" v-model="form.paid_amount" placeholder="0 (æŒ‚è´¦)" class="w-full p-2 pl-12 rounded border border-gray-200 text-sm font-bold text-blue-600 focus:border-blue-500 outline-none">
                    </div>
                    
                    <div class="text-xs mb-2 pl-1">
                        <span v-if="debtAmount > 0" class="text-red-500 font-bold">âš ï¸ å‰©ä½™ Â¥[[ debtAmount ]] è®¡å…¥åº”ä»˜è´¦æ¬¾</span>
                        <span v-else-if="!form.paid_amount || form.paid_amount == 0" class="text-red-500 font-bold">âš ï¸ å…¨é¢æŒ‚è´¦ (æ¬ æ¬¾)</span>
                        <span v-else class="text-blue-600 font-bold">âœ… å…¨é¢å·²ä»˜</span>
                    </div>

                    <div v-if="form.paid_amount > 0" class="animate-fade-in">
                        <select v-model="form.account_id" class="w-full p-2 rounded border border-gray-200 text-sm bg-white">
                            <option value="" disabled>æ”¯ä»˜è´¦æˆ· (å¿…é€‰)</option>
                            <option v-for="acc in accounts" :value="acc.id">[[ acc.name ]]</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3 pt-2 border-t border-gray-200">
                    <input type="number" v-model="form.peer_price" placeholder="åŒè¡Œåº•ä»·" class="w-full p-2 bg-white border border-gray-200 text-sm rounded">
                    <input type="number" v-model="form.retail_price" placeholder="é›¶å”®æŒ‡å¯¼" class="w-full p-2 bg-white border border-gray-200 text-sm rounded">
                </div>
            </div>

            <button @click="submit" :disabled="loading" class="w-full bg-blue-600 text-white font-bold py-4 rounded-xl shadow-lg shadow-blue-200 active:scale-95 transition-transform">
                [[ loading ? 'æäº¤ä¸­...' : 'ç¡®è®¤å…¥åº“' ]]
            </button>
        </div>

        <el-dialog v-model="showSuccess" title="å…¥åº“æˆåŠŸ" width="90%" center :show-close="false" :close-on-click-modal="false" :close-on-press-escape="false">
            <div class="text-center py-2">
                <div class="mb-4">
                    <span class="text-4xl">âœ…</span>
                </div>
                <div class="text-gray-500 text-xs mb-1">ç³»ç»Ÿå”¯ä¸€ç¼–ç </div>
                <div class="text-2xl font-mono font-bold text-gray-800 bg-gray-100 p-2 rounded select-all tracking-wider">
                    [[ result.zencode ]]
                </div>
                
                <div v-if="!result.has_price" class="mt-4 p-3 bg-orange-50 border border-orange-100 rounded-lg text-left">
                    <div class="text-xs text-orange-600 font-bold flex items-center gap-1">
                        <span>âš ï¸ ä»·æ ¼æœªå®Œå–„</span>
                    </div>
                    <div class="text-[10px] text-orange-400 mt-1">
                        æ‚¨æœªå¡«å†™åŒè¡Œåº•ä»·æˆ–é›¶å”®ä»·ï¼Œè¯·è®°å¾—åœ¨åº“å­˜æ¸…å•ä¸­è¡¥å……ç»´æŠ¤ï¼
                    </div>
                </div>
            </div>
            <template #footer>
                <el-button type="primary" @click="resetForm" class="w-full" size="large">ç»§ç»­ä¸‹ä¸€å•</el-button>
            </template>
        </el-dialog>

        <el-dialog v-model="showAddModal" title="æ–°å»ºä¾›åº”å•†" width="90%">
            <div class="space-y-3">
                <el-input v-model="newContact.name" placeholder="å§“å (å¿…å¡«)"></el-input>
                <el-input v-model="newContact.phone" placeholder="ç”µè¯"></el-input>
                <el-input v-model="newContact.address" placeholder="åœ°å€/æ¡£å£"></el-input>
            </div>
            <template #footer>
                <el-button @click="showAddModal=false">å–æ¶ˆ</el-button>
                <el-button type="primary" @click="addContact">ä¿å­˜</el-button>
            </template>
        </el-dialog>

    </div>

    <script>
        const { createApp } = Vue
        const { ElMessage } = ElementPlus
        axios.defaults.headers.common['X-CSRFToken'] = '{{ csrf_token }}';

        createApp({
            data() {
                return {
                    types: [{key: 'ZJ', name: 'æ•´æœº'}, {key: 'SJ', name: 'æ•£ä»¶'}, {key: 'XS', name: 'æ˜¾ç¤ºå™¨'}, {key: 'ZX', name: 'æ‚é¡¹'}],
                    form: { 
                        category: 'ZJ', supplier_id: '', name: '', 
                        cpu: '', gpu: '', ram: '', disk: '', note: '', 
                        cost_price: '', paid_amount: '', account_id: '',
                        peer_price: '', retail_price: '', image: null 
                    },
                    contacts: [], accounts: [],
                    previewUrl: null, loading: false,
                    showAddModal: false, 
                    showSuccess: false, // æ§åˆ¶æˆåŠŸå¼¹çª—
                    newContact: { name: '', phone: '', address: '' },
                    result: { zencode: '', has_price: true }
                }
            },
            computed: {
                debtAmount() {
                    const cost = parseFloat(this.form.cost_price || 0);
                    const paid = parseFloat(this.form.paid_amount || 0);
                    return (cost - paid).toFixed(2);
                }
            },
            mounted() { this.loadData(); },
            methods: {
                async loadData() {
                    try { 
                        const [cRes, aRes] = await Promise.all([
                            axios.get('/api/contacts/'),
                            axios.get('/api/analysis/accounting/')
                        ]);
                        this.contacts = cRes.data.results || cRes.data;
                        this.accounts = aRes.data.accounts || []; 
                        if(this.accounts.length > 0) this.form.account_id = this.accounts[0].id;
                    } catch(e){}
                },
                async addContact() {
                    if(!this.newContact.name) return ElMessage.warning('å§“åå¿…å¡«');
                    try {
                        const res = await axios.post('/api/contacts/', this.newContact);
                        await this.loadData();
                        this.form.supplier_id = res.data.id;
                        this.showAddModal = false;
                        this.newContact = { name: '', phone: '', address: '' };
                    } catch(e) { ElMessage.error('æ–°å»ºå¤±è´¥'); }
                },
                handleFileUpload(event) {
                    const file = event.target.files[0];
                    if (file) { this.form.image = file; this.previewUrl = URL.createObjectURL(file); }
                },
                async submit() {
                    if (this.form.supplier_id === '') return ElMessage.warning('å¿…é¡»é€‰æ‹©ä¾›åº”å•†');
                    if (!this.form.cost_price) return ElMessage.warning('è¯·å¡«å†™å…¥åº“æˆæœ¬');
                    
                    const paid = parseFloat(this.form.paid_amount || 0);
                    if(paid > 0 && !this.form.account_id) return ElMessage.warning('å®ä»˜å¿…é¡»é€‰è´¦æˆ·');

                    this.loading = true;
                    const formData = new FormData();
                    if (this.form.category !== 'ZJ' && !this.form.name) { this.loading = false; return ElMessage.warning('è¯·å¡«å†™åç§°'); }
                    
                    for (let key in this.form) if (this.form[key] || this.form[key]===0) formData.append(key, this.form[key]);
                    
                    try {
                        const res = await axios.post('/api/products/', formData, { headers: { 'Content-Type': 'multipart/form-data' }});
                        
                        // é€»è¾‘ï¼šåˆ¤æ–­æ˜¯å¦å¡«å†™äº†å”®ä»·
                        const hasPeer = !!this.form.peer_price;
                        const hasRetail = !!this.form.retail_price;
                        
                        this.result.zencode = res.data.zencode;
                        this.result.has_price = hasPeer || hasRetail; // åªè¦å¡«äº†ä¸€ä¸ªå°±ç®—æœ‰
                        
                        // æ‰“å¼€é”å®šå¼¹çª—
                        this.showSuccess = true;
                        
                    } catch (e) { ElMessage.error('æäº¤å¤±è´¥: ' + (e.response?.data?.detail || e.message)); }
                    finally { this.loading = false; }
                },
                resetForm() {
                    this.showSuccess = false;
                    const cat = this.form.category;
                    const sup = this.form.supplier_id; 
                    const acc = this.form.account_id;
                    this.form = { 
                        category: cat, supplier_id: sup, name: '', 
                        cpu: '', gpu: '', ram: '', disk: '', note: '', 
                        cost_price: '', paid_amount: '', account_id: acc,
                        peer_price: '', retail_price: '', image: null 
                    };
                    this.previewUrl = null; 
                    this.$refs.fileInput.value = '';
                }
            },
            compilerOptions: { delimiters: ['[[', ']]'] }
        }).use(ElementPlus).mount('#app');
    </script>
</body>
</html>